<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UX Flow Checklist - å…¨æ–¹ä½æµç¨‹æª¢æŸ¥å™¨</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed', // Primary Vivid Purple
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        },
                        neutral: {
                            900: '#111827', // High contrast text
                            500: '#6b7280', // Secondary text
                            100: '#f3f4f6', // Light gray bg
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'in': 'fadeIn 0.3s ease-out',
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                        'zoom-in': 'zoomIn 0.2s ease-out',
                        'slide-up-fade': 'slideUpFade 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeInUp: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        slideInRight: {
                            'from': { transform: 'translateX(100%)' },
                            'to': { transform: 'translateX(0)' },
                        },
                        zoomIn: {
                            'from': { opacity: '0', transform: 'scale(0.95)' },
                            'to': { opacity: '1', transform: 'scale(1)' },
                        },
                        slideUpFade: {
                            'from': { opacity: '0', transform: 'translate(-50%, 100%)' },
                            'to': { opacity: '1', transform: 'translate(-50%, 0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Mermaid.js for Diagrams -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.0/dist/mermaid.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for code blocks */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5f3ff;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ddd6fe;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #c4b5fd;
        }
        /* Mermaid specific styles */
        .mermaid svg {
            max-width: 100%;
            height: auto;
        }
        /* No scrollbar utility */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-900 antialiased selection:bg-brand-200 selection:text-brand-900 text-base">
    <div id="root"></div>

    <script type="text/babel">
        // Default API Key (System provided)
        const defaultApiKey = ""; 

        const { useState, useEffect, useRef, useMemo } = React;
        
        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false, 
            theme: 'base',
            themeVariables: {
                primaryColor: '#ede9fe',
                primaryTextColor: '#4c1d95',
                primaryBorderColor: '#8b5cf6',
                lineColor: '#6b7280',
                secondaryColor: '#f3f4f6',
                tertiaryColor: '#fff',
            }
        });

        // --- Icons Components (SVG) ---
        const IconBase = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const LayoutTemplate = ({ className }) => (<IconBase className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="9" y2="21"/></IconBase>);
        const Loader2 = ({ className }) => (<IconBase className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>);
        const Sparkles = ({ className }) => (<IconBase className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconBase>);
        const AlertTriangle = ({ className }) => (<IconBase className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>);
        const CheckCircle = ({ className }) => (<IconBase className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>);
        const Clipboard = ({ className }) => (<IconBase className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconBase>);
        const Check = ({ className }) => (<IconBase className={className}><polyline points="20 6 9 17 4 12"/></IconBase>);
        const Zap = ({ className }) => (<IconBase className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>);
        const Box = ({ className }) => (<IconBase className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>);
        const RefreshCw = ({ className }) => (<IconBase className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>);
        const Globe = ({ className }) => (<IconBase className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>);
        const ChevronDown = ({ className }) => (<IconBase className={className}><polyline points="6 9 12 15 18 9"/></IconBase>);
        const ChevronUp = ({ className }) => (<IconBase className={className}><polyline points="18 15 12 9 6 15"/></IconBase>);
        const Users = ({ className }) => (<IconBase className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>);
        const Smartphone = ({ className }) => (<IconBase className={className}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>);
        const ShieldAlert = ({ className }) => (<IconBase className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>);
        const Briefcase = ({ className }) => (<IconBase className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>);
        const Network = ({ className }) => (<IconBase className={className}><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></IconBase>);
        const ExternalLink = ({ className }) => (<IconBase className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>);
        const X = ({ className, onClick }) => (<IconBase className={className} onClick={onClick}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>);
        const ImageIcon = ({ className }) => (<IconBase className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>);
        const ArrowLeft = ({ className }) => (<IconBase className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>);
        const Target = ({ className }) => (<IconBase className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>);
        const HistoryIcon = ({ className }) => (<IconBase className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>);
        const Trash2 = ({ className }) => (<IconBase className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>);
        const Clock = ({ className }) => (<IconBase className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>);
        const CodeIcon = ({ className }) => (<IconBase className={className}><polyline points="16 18 22 12 16 6" /><polyline points="8 6 2 12 8 18" /></IconBase>);
        const Image = ({ className }) => (<IconBase className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><circle cx="9" cy="9" r="2" /><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" /></IconBase>);
        const PieChart = ({ className }) => (<IconBase className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></IconBase>);
        const KeyIcon = ({ className }) => (<IconBase className={className}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" /></IconBase>);


        // --- Helper Function for JSON Parsing ---
        const parseGeminiResponse = (text) => {
            try {
                return JSON.parse(text);
            } catch (e) {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                    const jsonString = text.substring(firstBrace, lastBrace + 1);
                    try {
                        return JSON.parse(jsonString);
                    } catch (e2) {
                        console.error("Failed to parse extracted JSON:", e2);
                        throw e;
                    }
                } else {
                    throw e;
                }
            }
        };

        // --- Helper: Fix Common Mermaid Errors ---
        const fixCommonMermaidErrors = (code) => {
            if (!code) return code;
            let fixed = code;
            // Enhanced Fixer: Aggressively quote content in {}, [], () if not quoted
            fixed = fixed.replace(/([A-Za-z0-9_\-\.]+)(\s*\{)(?!\{)([^\"\}\n]+)(\})/g, '$1$2"$3"$4');
            fixed = fixed.replace(/([A-Za-z0-9_\-\.]+)(\s*\()(?!\()([^\"\)\n]+)(\))/g, '$1$2"$3"$4');
            fixed = fixed.replace(/([A-Za-z0-9_\-\.]+)(\s*\[)(?!\[)([^\"\]\n]+)(\])/g, '$1$2"$3"$4');

            return fixed;
        };

        // --- Mermaid Renderer Component ---
        const MermaidDiagram = ({ code }) => {
            const [svg, setSvg] = useState('');
            const [error, setError] = useState(null);

            useEffect(() => {
                const render = async () => {
                    if (!code) return;
                    try {
                        setError(null);
                        const id = `mermaid-${Math.random().toString(36).substr(2, 9)}`;
                        const { svg } = await mermaid.render(id, code);
                        setSvg(svg);
                    } catch (err) {
                        console.error("Mermaid error:", err);
                        setError("æµç¨‹åœ–èªæ³•ç”ŸæˆéŒ¯èª¤ï¼Œè«‹å˜—è©¦åˆ‡æ›è‡³ã€ŒåŸå§‹ç¢¼ã€æ¨¡å¼æŸ¥çœ‹æˆ–é‡æ–°ç”Ÿæˆã€‚");
                    }
                };
                render();
            }, [code]);

            if (error) return (
                <div className="p-6 text-red-500 bg-red-50 rounded-xl border border-red-100 flex items-center gap-3">
                    <AlertTriangle className="w-5 h-5 flex-shrink-0"/>
                    <span>{error}</span>
                </div>
            );
            
            return (
                <div 
                    className="w-full overflow-x-auto bg-white p-6 flex justify-center min-h-[300px]"
                    dangerouslySetInnerHTML={{ __html: svg }}
                />
            );
        };

        // --- Main Component ---
        function UXFlowMaster() {
            const [view, setView] = useState('home'); // 'home' | 'result'
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [resultKey, setResultKey] = useState(0); 
            const [toast, setToast] = useState(null); 
            const [copied, setCopied] = useState(false);
            const [mermaidCopied, setMermaidCopied] = useState(false);
            const [checkedItems, setCheckedItems] = useState({});
            const [currentHistoryId, setCurrentHistoryId] = useState(null); 
            const [activeTab, setActiveTab] = useState('details');
            const [activeDetailTab, setActiveDetailTab] = useState('happy_path'); // Only used for Legacy view
            const [activeStepId, setActiveStepId] = useState(null); // New: For tracking active step tab
            const [showDiagram, setShowDiagram] = useState(true); 
            const [showClearConfirm, setShowClearConfirm] = useState(false); 
            
            // API Key State
            const [showApiModal, setShowApiModal] = useState(false);
            const [userApiKey, setUserApiKey] = useState('');
            
            // Advanced Settings State
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [audience, setAudience] = useState('');
            const [platform, setPlatform] = useState('');
            const [constraints, setConstraints] = useState('');
            const [productType, setProductType] = useState('');
            const [designGoal, setDesignGoal] = useState('');

            // Image Upload State
            const [image, setImage] = useState(null); 
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);
            
            // History State
            const [history, setHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);

            useEffect(() => {
                const savedHistory = localStorage.getItem('ux_flow_history');
                if (savedHistory) {
                    try {
                        setHistory(JSON.parse(savedHistory));
                    } catch (e) {
                        console.error("Failed to parse history", e);
                    }
                }
                
                const storedKey = localStorage.getItem('ux_flow_api_key');
                if (storedKey) {
                    setUserApiKey(storedKey);
                }
            }, []);

            // Calculate progress stats for the result view
            const progressStats = useMemo(() => {
                if (!result) return { total: 0, checked: 0, percent: 0 };
                
                let total = 0;
                let checked = 0;

                // Support new Structure (Steps)
                if (result.steps) {
                    // Added 'user_negative_flow' to tracking categories
                    const categories = ['happy_path', 'negative_path', 'user_negative_flow', 'edge_cases', 'system_states'];
                    result.steps.forEach(step => {
                        categories.forEach(cat => {
                            if (step[cat] && Array.isArray(step[cat])) {
                                step[cat].forEach(item => {
                                    total++;
                                    if (checkedItems[item.id]) checked++;
                                });
                            }
                        });
                    });
                     // Add cross page impacts to stats
                    if(result.cross_page_impacts) {
                        result.cross_page_impacts.forEach(item => {
                            total++;
                            if (checkedItems[item.id]) checked++;
                        });
                    }

                } else {
                    // Legacy Structure
                    const trackableCategories = ['happy_path', 'negative_path', 'edge_cases', 'system_states', 'cross_page_impacts'];
                    trackableCategories.forEach(key => {
                        if (result[key] && Array.isArray(result[key])) {
                            result[key].forEach(item => {
                                total++;
                                if (checkedItems[item.id]) checked++;
                            });
                        }
                    });
                }
                
                return { 
                    total, 
                    checked, 
                    percent: total > 0 ? Math.round((checked / total) * 100) : 0 
                };
            }, [result, checkedItems]);

            useEffect(() => {
                if (result) {
                    setActiveTab('details');
                    setActiveDetailTab('happy_path'); 
                    
                    // Initialize active step if steps exist
                    if (result.steps && result.steps.length > 0) {
                        setActiveStepId(result.steps[0].id);
                    }

                    setShowDiagram(true);
                    setResultKey(Date.now()); 
                    setView('result'); 
                    window.scrollTo({ top: 0, behavior: 'smooth' }); 
                }
            }, [result]);

            const showToastMessage = (message, type = 'success') => {
                setToast({ message, type });
                setTimeout(() => setToast(null), 3000);
            };

            const handleSaveApiKey = () => {
                localStorage.setItem('ux_flow_api_key', userApiKey);
                setShowApiModal(false);
                showToastMessage("API Key å·²å„²å­˜");
            };

            const toggleCheck = (id) => {
                const newCheckedItems = {
                    ...checkedItems,
                    [id]: !checkedItems[id]
                };
                setCheckedItems(newCheckedItems);

                if (currentHistoryId) {
                    const updatedHistory = history.map(item => {
                        if (item.id === currentHistoryId) {
                            return { ...item, checkedItems: newCheckedItems };
                        }
                        return item;
                    });
                    setHistory(updatedHistory);
                    localStorage.setItem('ux_flow_history', JSON.stringify(updatedHistory));
                }
            };

            // --- History Functions ---
            const saveToHistory = (newResult, params) => {
                const newItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    result: newResult,
                    checkedItems: {}, 
                    params: {
                        input: params.input,
                        audience: params.audience,
                        platform: params.platform,
                        constraints: params.constraints,
                        productType: params.productType,
                        designGoal: params.designGoal,
                        hasImage: !!params.image 
                    }
                };

                const updatedHistory = [newItem, ...history].slice(0, 20); 
                setHistory(updatedHistory);
                localStorage.setItem('ux_flow_history', JSON.stringify(updatedHistory));
                return newItem.id;
            };

            const loadHistoryItem = (item) => {
                const { params, result: savedResult, id, checkedItems: savedCheckedItems } = item;
                setInput(params.input || '');
                setAudience(params.audience || '');
                setPlatform(params.platform || '');
                setConstraints(params.constraints || '');
                setProductType(params.productType || '');
                setDesignGoal(params.designGoal || '');
                setImage(null); 
                
                setResult(savedResult);
                setCheckedItems(savedCheckedItems || {});
                setCurrentHistoryId(id);
                
                // Initialize active step for history items too
                if (savedResult.steps && savedResult.steps.length > 0) {
                    setActiveStepId(savedResult.steps[0].id);
                }

                setShowHistory(false); 
                setView('result'); 
                setResultKey(Date.now());
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const deleteHistoryItem = (e, id) => {
                e.stopPropagation();
                const updatedHistory = history.filter(item => item.id !== id);
                setHistory(updatedHistory);
                localStorage.setItem('ux_flow_history', JSON.stringify(updatedHistory));
                if (currentHistoryId === id) {
                    setCurrentHistoryId(null); 
                }
            };

            const handleClearHistoryClick = () => {
                setShowClearConfirm(true);
            };

            const confirmClearHistory = () => {
                setHistory([]);
                localStorage.removeItem('ux_flow_history');
                setCurrentHistoryId(null);
                setShowClearConfirm(false);
                showToastMessage("æ­·å²ç´€éŒ„å·²æ¸…ç©º");
            };

            // --- Image Handling Functions ---
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        processFile(file);
                        break;
                    }
                }
            };

            const processFile = (file) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    setImage(base64String);
                };
                reader.readAsDataURL(file);
            };

            const removeImage = () => {
                setImage(null);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleBackToHome = () => {
                setView('home');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const generateFlows = async () => {
                if (!input.trim() && !image) return;
                
                const currentApiKey = userApiKey || defaultApiKey;
                if (!currentApiKey) {
                    setShowApiModal(true);
                    showToastMessage("è«‹å…ˆè¨­å®š API Key", "error");
                    return;
                }

                setLoading(true);
                setResult(null);

                try {
                    let userQueryText = `æˆ‘è¦è¨­è¨ˆçš„åŠŸèƒ½æ˜¯ï¼š${input}ã€‚`;
                    if (designGoal.trim()) userQueryText += `\nè¨­è¨ˆç›®çš„ï¼š${designGoal}ã€‚`;
                    if (productType.trim()) userQueryText += `\nç”¢å“é¡å‹ï¼š${productType}ã€‚`;
                    if (audience.trim()) userQueryText += `\nç›®æ¨™æ—ç¾¤ï¼š${audience}ã€‚`;
                    if (platform.trim()) userQueryText += `\næ“ä½œå¹³å°ï¼š${platform}ã€‚`;
                    if (constraints.trim()) userQueryText += `\nç‰¹æ®Šé™åˆ¶/æƒ…å¢ƒï¼š${constraints}ã€‚`;
                    
                    if (image) {
                        userQueryText += `\né™„åœ–æ˜¯æˆ‘ç›®å‰çš„ä»‹é¢è¨­è¨ˆè‰åœ–/æˆªåœ–ï¼Œè«‹é‡å°æ­¤ç•«é¢åˆ†æå¯èƒ½ç¼ºå¤±çš„æµç¨‹èˆ‡ç‹€æ…‹ã€‚`;
                    }

                    // Updated prompt request to include Negative User Flows
                    userQueryText += `\nè«‹æ”¹ç”¨ã€Œæ­¥é©Ÿå°å‘ã€çš„æ–¹å¼åˆ†æã€‚è«‹å°‡ä½¿ç”¨è€…æ“ä½œæµç¨‹**æ‹†è§£å¾—éå¸¸è©³ç´°**ã€‚è«‹ç›¡é‡åˆ—å‡º **8 åˆ° 15 å€‹** è©³ç´°æ­¥é©Ÿã€‚æ¯å€‹æ­¥é©Ÿéƒ½è¦è©³ç´°åˆ—å‡ºï¼šç†æƒ³æµç¨‹ã€éŒ¯èª¤ç‹€æ…‹ã€æ¶ˆæ¥µæ“ä½œ(å¦‚è¿”å›/åˆªé™¤/å–æ¶ˆ)ã€æ¥µé™æƒ…æ³ã€ç³»çµ±ç‹€æ…‹ã€‚`;

                    const systemPrompt = `
                        ä½ æ˜¯ä¸€ä½è³‡æ·±çš„ UX/UI è¨­è¨ˆå¸«èˆ‡ç”¢å“ç¶“ç†å°ˆå®¶ã€‚ä½ çš„ä»»å‹™æ˜¯å¹«åŠ© UI è¨­è¨ˆå¸«æ‰¾å‡ºç‰¹å®šåŠŸèƒ½çš„æ‰€æœ‰æ½›åœ¨ç‹€æ…‹å’Œæµç¨‹ã€‚
                        
                        è«‹å°‡è¼¸å‡ºçµæ§‹èª¿æ•´ç‚ºã€Œä¾æ“šæ“ä½œæµç¨‹æ­¥é©Ÿåˆ†é¡ã€ã€‚
                        
                        **é—œéµæŒ‡ä»¤ï¼šè«‹å‹™å¿…å°‡æµç¨‹æ‹†è§£å¾—éå¸¸ç´°ç·»**ã€‚
                        ä¸è¦åªåˆ—å‡ºã€Œå¡«å¯«è¡¨å–®ã€é€™æ¨£çš„å¤§æ­¥é©Ÿï¼Œè«‹å°‡å…¶æ‹†è§£ç‚ºï¼šã€Œé€²å…¥ç•«é¢ã€ã€ã€Œé»æ“Šè¼¸å…¥æ¡†ã€ã€ã€Œè¼¸å…¥å…§å®¹ä¸­ã€ã€ã€Œè¼¸å…¥å®Œæˆ/å¤±å»ç„¦é»ã€ã€ã€Œå³æ™‚é©—è­‰å›é¥‹ã€ã€ã€Œé»æ“Šé€å‡ºæŒ‰éˆ•ã€ç­‰å¾®äº’å‹•ã€‚
                        
                        è«‹ç›¡é‡åˆ—å‡º **8 åˆ° 15 å€‹æ­¥é©Ÿ**ï¼Œä¸¦åœ¨æ¯å€‹æ­¥é©Ÿä¸‹åˆ†åˆ¥åˆ—å‡ºï¼š
                        1. happy_path (è©²æ­¥é©Ÿçš„ç†æƒ³ç‹€æ…‹) - è‡³å°‘ 2-3 é»
                        2. negative_path (è©²æ­¥é©Ÿå¯èƒ½ç™¼ç”Ÿçš„éŒ¯èª¤/ç³»çµ±éŒ¯èª¤) - è‡³å°‘ 2-3 é»
                        3. user_negative_flow (ä½¿ç”¨è€…ä¸»å‹•çš„æ¶ˆæ¥µæ“ä½œ) - é€™æ˜¯æŒ‡ä½¿ç”¨è€…**åæ‚”ã€å–æ¶ˆã€åˆªé™¤ã€è¿”å›**ç­‰æ“ä½œã€‚ä¾‹å¦‚ï¼šæ¸…ç©ºå·²è¼¸å…¥æ–‡å­—ã€é»æ“Šè¿”å›ä¸Šä¸€é ã€å–æ¶ˆå°è©±æ¡†ã€é—œé–‰åˆ†é ã€‚è«‹å‹™å¿…æ€è€ƒä½¿ç”¨è€…åœ¨æ­¤æ­¥é©Ÿå¯èƒ½åšçš„ã€Œä¸åšã€æˆ–ã€Œå€’é€€ã€è¡Œç‚ºã€‚ - è‡³å°‘ 2-3 é»
                        4. edge_cases (è©²æ­¥é©Ÿçš„é‚Šç•Œæ¢ä»¶) - è‡³å°‘ 2-3 é»
                        5. system_states (è©²æ­¥é©Ÿçš„ç³»çµ±å›é¥‹) - è‡³å°‘ 1-2 é»

                        å¦å¤–å°‡ã€Œè·¨é é¢å½±éŸ¿ã€èˆ‡ã€Œç«¶å“åƒè€ƒã€åˆ—ç‚ºå…¨åŸŸé …ç›®ã€‚
                        
                        **è‹¥ä½¿ç”¨è€…æä¾›äº†åœ–ç‰‡**ï¼š
                        1. è«‹ä»”ç´°åˆ†æåœ–ç‰‡ä¸­çš„å…ƒä»¶ï¼ˆä¾‹å¦‚ï¼šæŒ‰éˆ•ã€è¼¸å…¥æ¡†ã€å°èˆªåˆ—ï¼‰ã€‚
                        2. æ ¹æ“šåœ–ç‰‡å…§å®¹ï¼ŒæŒ‡å‡º**è¦–è¦ºä¸Šç¼ºå¤±**æˆ–**é‚è¼¯ä¸Šéºæ¼**çš„ç‹€æ…‹ã€‚
                        3. çµåˆåœ–ç‰‡èˆ‡æ–‡å­—æè¿°ï¼Œæä¾›å®Œæ•´çš„æ”¹å–„å»ºè­°ã€‚

                        Mermaid åœ–è¡¨é‚è¼¯ä¸è®Šï¼Œè«‹ç¹ªè£½å®Œæ•´çš„æµç¨‹åœ–ã€‚
                        **ç‰¹åˆ¥æ³¨æ„**ï¼šMermaid ç¯€é»æ¨™ç±¤è‹¥åŒ…å«æ‹¬è™Ÿ ()ã€ä¸­æ‹¬è™Ÿ []ã€å¤§æ‹¬è™Ÿ {}ï¼Œè«‹å‹™å¿…ä½¿ç”¨é›™å¼•è™ŸåŒ…è£¹å…§å®¹ã€‚
                        
                        è«‹ä»¥åš´æ ¼çš„ JSON æ ¼å¼å›å‚³ï¼Œä¸è¦ä½¿ç”¨ markdown code blockï¼Œä¸è¦æœ‰ä»»ä½•è¨»é‡‹ã€‚
                        Response MUST be valid JSON string only.
                        {
                          "steps": [
                            {
                              "id": "step1",
                              "title": "æ­¥é©Ÿ 1ï¼šè©³ç´°æ­¥é©Ÿåç¨±",
                              "happy_path": [{ "id": "s1_h1", "title": "æ¨™é¡Œ", "desc": "è©³ç´°æè¿°" }],
                              "negative_path": [{ "id": "s1_n1", "title": "æ¨™é¡Œ", "desc": "è©³ç´°æè¿°" }],
                              "user_negative_flow": [{ "id": "s1_u1", "title": "æ¨™é¡Œ", "desc": "ä¾‹å¦‚ï¼šèª¤è§¸è¿”å›éµã€é»æ“Šæ¸…é™¤æŒ‰éˆ•" }],
                              "edge_cases": [{ "id": "s1_e1", "title": "æ¨™é¡Œ", "desc": "è©³ç´°æè¿°" }],
                              "system_states": [{ "id": "s1_s1", "title": "æ¨™é¡Œ", "desc": "è©³ç´°æè¿°" }]
                            }
                          ],
                          "cross_page_impacts": [{ "id": "c1", "title": "æ¨™é¡Œ", "desc": "è©³ç´°æè¿°" }],
                          "competitor_references": [{ "id": "r1", "title": "ç”¢å“åç¨±", "desc": "å€¼å¾—åƒè€ƒçš„è¨­è¨ˆç´°ç¯€èˆ‡åŸå› " }],
                          "user_flow_mermaid": "graph TD..."
                        }
                    `;

                    const parts = [{ text: userQueryText }];
                    if (image) {
                        const matches = image.match(/^data:(.+);base64,(.+)$/);
                        if (matches && matches.length === 3) {
                            parts.push({
                                inlineData: {
                                    mimeType: matches[1],
                                    data: matches[2]
                                }
                            });
                        }
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: parts }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    
                    const parsedData = parseGeminiResponse(text);
                    
                    if (parsedData.user_flow_mermaid) {
                        parsedData.user_flow_mermaid = fixCommonMermaidErrors(parsedData.user_flow_mermaid);
                    }
                    
                    setCheckedItems({});
                    
                    const newId = saveToHistory(parsedData, {
                        input, audience, platform, constraints, productType, designGoal, image
                    });
                    
                    setCurrentHistoryId(newId);
                    setResult(parsedData);

                } catch (err) {
                    console.error(err);
                    showToastMessage('ç”Ÿæˆå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚' + err.message, 'error');
                } finally {
                    setLoading(false);
                }
            };

            const copyToClipboard = () => {
                if (!result) return;
                
                let text = `UX Design Checklist: ${input}\n`;
                if (designGoal) text += `Design Goal: ${designGoal}\n`;
                text += '\n';
                
                if (result.steps) {
                    // New Structure
                    result.steps.forEach(step => {
                        text += `### ${step.title}\n`;
                        
                        if(step.happy_path?.length) {
                            text += `ğŸŸ¢ æ­£å‘æµç¨‹ (Happy Path):\n`;
                            step.happy_path.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        }
                        // Moved User Negative Flow here (right after Happy Path)
                        if(step.user_negative_flow?.length) {
                            text += `ğŸŸ  è² å‘æµç¨‹ (Negative Actions):\n`;
                            step.user_negative_flow.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        }
                        if(step.negative_path?.length) {
                            text += `ğŸ”´ éŒ¯èª¤æµç¨‹ (Error States):\n`;
                            step.negative_path.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        }
                        if(step.edge_cases?.length) {
                            text += `âš¡ æ¥µé™æƒ…æ³:\n`;
                            step.edge_cases.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        }
                        if(step.system_states?.length) {
                            text += `âšª ç³»çµ±ç‹€æ…‹:\n`;
                            step.system_states.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        }
                        text += '\n';
                    });

                    if(result.cross_page_impacts?.length) {
                        text += `### ğŸ”— è·¨é é¢å½±éŸ¿\n`;
                        result.cross_page_impacts.forEach(i => text += `- [ ] ${i.title}: ${i.desc}\n`);
                        text += '\n';
                    }
                } else {
                    // Legacy Structure Fallback
                     const categories = [
                        { key: 'happy_path', label: 'ğŸŸ¢ æ­£å‘æµç¨‹ (Happy Path)' },
                        { key: 'negative_path', label: 'ğŸ”´ éŒ¯èª¤æµç¨‹ (Error States)' },
                        { key: 'edge_cases', label: 'âš¡ æ¥µé™èˆ‡é‚Šç•Œ (Limit Cases)' },
                        { key: 'system_states', label: 'âšª ç©ºç™½èˆ‡è¼‰å…¥ (Empty & Loading)' },
                        { key: 'cross_page_impacts', label: 'ğŸ”— è·¨é é¢å½±éŸ¿ (Cross-page Impacts)' },
                        { key: 'competitor_references', label: 'ğŸ” ç«¶å“åƒè€ƒ (Competitor References)' }
                    ];

                    categories.forEach(cat => {
                        if (result[cat.key]) {
                            text += `${cat.label}\n`;
                            result[cat.key].forEach(item => {
                                text += `- [ ] ${item.title}: ${item.desc}\n`;
                            });
                            text += '\n';
                        }
                    });
                }

                if (result.user_flow_mermaid) {
                    text += `\nğŸŒŠ User Flow (Mermaid):\n\`\`\`mermaid\n${result.user_flow_mermaid}\n\`\`\``;
                }

                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    showToastMessage('å ±å‘Šå…§å®¹å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    showToastMessage('è¤‡è£½å¤±æ•—', 'error');
                }
                document.body.removeChild(el);
            };

            const copyMermaid = () => {
                if (!result?.user_flow_mermaid) return;
                
                const el = document.createElement('textarea');
                el.value = result.user_flow_mermaid;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    setMermaidCopied(true);
                    showToastMessage('Mermaid ä»£ç¢¼å·²è¤‡è£½ï¼');
                    setTimeout(() => setMermaidCopied(false), 2000);
                } catch (err) {
                      console.error('Fallback copy failed', err);
                      showToastMessage('è¤‡è£½å¤±æ•—', 'error');
                }
                document.body.removeChild(el);
            };

            const getMermaidLiveUrl = (code) => {
                try {
                    const state = {
                      code: code,
                      mermaid: { "theme": "default" },
                      autoSync: true,
                      updateDiagram: true
                    };
                    const json = JSON.stringify(state);
                    const base64 = window.btoa(unescape(encodeURIComponent(json)));
                    return `https://mermaid.live/edit#base64:${base64}`;
                } catch (e) {
                    return "#";
                }
            };

            // Configuration for Detail Sub-tabs (Legacy)
            const detailTabs = [
                { id: 'happy_path', label: 'æ­£å‘æµç¨‹', fullLabel: 'æ­£å‘æµç¨‹ (Happy Path)', icon: Zap, iconColor: 'text-yellow-500', borderColor: 'border-t-yellow-400', bgHover: 'hover:bg-yellow-50', textActive: 'text-yellow-700', borderActive: 'border-yellow-500', bgActive: 'bg-yellow-50' },
                { id: 'negative_path', label: 'éŒ¯èª¤æµç¨‹', fullLabel: 'éŒ¯èª¤æµç¨‹ (Error States)', icon: AlertTriangle, iconColor: 'text-red-500', borderColor: 'border-t-red-400', bgHover: 'hover:bg-red-50', textActive: 'text-red-700', borderActive: 'border-red-500', bgActive: 'bg-red-50' },
                { id: 'edge_cases', label: 'æ¥µé™æƒ…æ³', fullLabel: 'æ¥µé™èˆ‡é‚Šç•Œ (Limit Cases)', icon: Box, iconColor: 'text-purple-500', borderColor: 'border-t-purple-400', bgHover: 'hover:bg-purple-50', textActive: 'text-purple-700', borderActive: 'border-purple-500', bgActive: 'bg-purple-50' },
                { id: 'system_states', label: 'ç³»çµ±ç‹€æ…‹', fullLabel: 'ç©ºç™½èˆ‡è¼‰å…¥ (Empty & Loading)', icon: RefreshCw, iconColor: 'text-blue-500', borderColor: 'border-t-blue-400', bgHover: 'hover:bg-blue-50', textActive: 'text-blue-700', borderActive: 'border-blue-500', bgActive: 'bg-blue-50' },
                { id: 'cross_page_impacts', label: 'è·¨é é¢', fullLabel: 'è·¨é é¢å½±éŸ¿ (Cross-page Impacts)', icon: Network, iconColor: 'text-orange-500', borderColor: 'border-t-orange-400', bgHover: 'hover:bg-orange-50', textActive: 'text-orange-700', borderActive: 'border-orange-500', bgActive: 'bg-orange-50' },
            ];

            return (
                <div className="min-h-screen font-sans flex flex-col items-center relative overflow-x-hidden bg-neutral-50">
                    
                    {/* Top Right Buttons - Only visible on Home */}
                    {view === 'home' && (
                        <div className="fixed top-6 right-6 z-30 flex gap-2">
                             <button 
                                onClick={() => setShowApiModal(true)}
                                className="bg-white p-3 rounded-full shadow-lg border border-gray-200 text-gray-500 hover:text-brand-600 hover:border-brand-300 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all group relative"
                                title="è¨­å®š API Key"
                            >
                                <KeyIcon className="w-5 h-5" />
                            </button>
                             <button 
                                onClick={() => setShowHistory(true)}
                                className="flex items-center gap-2 bg-white px-5 py-3 rounded-full shadow-lg border border-gray-200 text-neutral-600 font-bold hover:text-brand-600 hover:border-brand-300 hover:shadow-xl hover:-translate-y-0.5 active:translate-y-0 transition-all group relative"
                                title="æ­·å²ç´€éŒ„"
                            >
                                <HistoryIcon className="w-5 h-5" />
                                <span>æ­·å²ç´€éŒ„</span>
                            </button>
                        </div>
                    )}

                    {/* MODAL: API Key Settings */}
                    {showApiModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200" 
                                onClick={() => setShowApiModal(false)}
                            ></div>
                            
                            {/* Modal Content */}
                            <div className="relative w-full max-w-md bg-white rounded-2xl shadow-2xl flex flex-col animate-zoom-in overflow-hidden p-6 space-y-6">
                                <div className="flex justify-between items-center">
                                    <h3 className="font-bold text-xl text-gray-900 flex items-center gap-2">
                                        <KeyIcon className="w-5 h-5 text-brand-600" />
                                        è¨­å®š API Key
                                    </h3>
                                    <button onClick={() => setShowApiModal(false)} className="text-gray-400 hover:text-gray-600">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    <p className="text-base text-gray-500 leading-relaxed">
                                        è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥ä½¿ç”¨ç”ŸæˆåŠŸèƒ½ã€‚æ‚¨çš„ Key åƒ…æœƒå„²å­˜åœ¨æœ¬åœ°ç€è¦½å™¨ä¸­ï¼Œä¸æœƒå‚³é€è‡³å…¶ä»–ä¼ºæœå™¨ã€‚
                                    </p>
                                    <div>
                                        <label className="block text-base font-medium text-gray-700 mb-1">API Key</label>
                                        <input 
                                            type="password" 
                                            value={userApiKey}
                                            onChange={(e) => setUserApiKey(e.target.value)}
                                            placeholder="è«‹è¼¸å…¥ AI API Key..."
                                            className="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all text-base"
                                        />
                                    </div>
                                </div>

                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => setShowApiModal(false)}
                                        className="flex-1 py-2.5 rounded-xl border border-gray-200 text-gray-600 font-medium hover:bg-gray-50 transition-colors text-base"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={handleSaveApiKey}
                                        className="flex-1 py-2.5 rounded-xl bg-brand-600 text-white font-medium hover:bg-brand-700 shadow-md shadow-brand-200 transition-all text-base"
                                    >
                                        å„²å­˜è¨­å®š
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: Confirmation for Clearing History */}
                    {showClearConfirm && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200" 
                                onClick={() => setShowClearConfirm(false)}
                            ></div>
                            
                            {/* Modal Content */}
                            <div className="relative w-full max-w-sm bg-white rounded-2xl shadow-2xl p-6 flex flex-col space-y-4 animate-zoom-in">
                                <div className="flex items-center gap-3 text-red-600">
                                    <div className="p-2 bg-red-50 rounded-full">
                                        <Trash2 className="w-6 h-6" />
                                    </div>
                                    <h3 className="font-bold text-lg text-gray-900">æ¸…ç©ºæ‰€æœ‰ç´€éŒ„ï¼Ÿ</h3>
                                </div>
                                <p className="text-gray-500 text-base leading-relaxed">
                                    æ­¤å‹•ä½œå°‡æœƒåˆªé™¤ç€è¦½å™¨ä¸­å„²å­˜çš„æ‰€æœ‰æ­·å²åˆ†æå ±å‘Šï¼Œä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ
                                </p>
                                <div className="flex gap-3 pt-2">
                                    <button 
                                        onClick={() => setShowClearConfirm(false)} 
                                        className="flex-1 py-2.5 rounded-xl border border-gray-200 text-gray-600 hover:bg-gray-50 font-medium transition-colors text-base"
                                    >
                                        å–æ¶ˆ
                                    </button>
                                    <button 
                                        onClick={confirmClearHistory} 
                                        className="flex-1 py-2.5 rounded-xl bg-red-600 text-white hover:bg-red-700 shadow-md shadow-red-200 font-medium transition-colors text-base"
                                    >
                                        ç¢ºèªæ¸…ç©º
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MODAL: HISTORY (Popup Style) */}
                    {showHistory && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                            {/* Backdrop */}
                            <div 
                                className="absolute inset-0 bg-black/40 backdrop-blur-sm animate-in fade-in duration-200" 
                                onClick={() => setShowHistory(false)}
                            ></div>
                            
                            {/* Modal Content */}
                            <div className="relative w-full max-w-4xl max-h-[85vh] bg-white rounded-2xl shadow-2xl flex flex-col animate-zoom-in overflow-hidden">
                                {/* Header */}
                                <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-brand-50 text-brand-600 rounded-xl">
                                            <HistoryIcon className="w-6 h-6" />
                                        </div>
                                        <div>
                                            <h3 className="font-bold text-xl text-gray-900">æ­·å²ç´€éŒ„</h3>
                                            <p className="text-sm text-gray-500">å…± {history.length} ç­†åˆ†æ</p>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        {history.length > 0 && (
                                            <button 
                                                onClick={handleClearHistoryClick}
                                                className="flex items-center gap-1.5 px-3 py-1.5 text-base text-red-500 hover:bg-red-50 rounded-lg transition-colors mr-2"
                                            >
                                                <Trash2 className="w-4 h-4" />
                                                æ¸…ç©º
                                            </button>
                                        )}
                                        <button 
                                            onClick={() => setShowHistory(false)} 
                                            className="p-2 hover:bg-gray-200 rounded-full text-gray-500 transition-colors"
                                        >
                                            <X className="w-6 h-6" />
                                        </button>
                                    </div>
                                </div>
                                
                                {/* Body */}
                                <div className="flex-1 overflow-y-auto p-6 bg-gray-50/30 custom-scrollbar">
                                    {history.length === 0 ? (
                                        <div className="text-center py-20 text-gray-400 flex flex-col items-center">
                                            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                                <HistoryIcon className="w-10 h-10 opacity-40" />
                                            </div>
                                            <p className="text-lg font-medium text-gray-500">å°šç„¡æ­·å²ç´€éŒ„</p>
                                            <p className="text-base mt-1 opacity-70">æ‚¨ç”Ÿæˆçš„åˆ†æå ±å‘Šæœƒè‡ªå‹•å„²å­˜æ–¼æ­¤</p>
                                        </div>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {history.map((item) => {
                                                const checkedCount = Object.values(item.checkedItems || {}).filter(Boolean).length;
                                                
                                                return (
                                                    <div key={item.id} 
                                                        onClick={() => loadHistoryItem(item)}
                                                        className="group bg-white border border-gray-200 rounded-xl p-5 hover:border-brand-300 hover:shadow-md hover:-translate-y-0.5 transition-all duration-200 cursor-pointer flex flex-col h-full relative"
                                                    >
                                                        <div className="flex justify-between items-start mb-3">
                                                            <span className="text-sm font-medium text-gray-400 flex items-center gap-1 bg-gray-50 px-2 py-1 rounded-full border border-gray-100">
                                                                <Clock className="w-3 h-3" />
                                                                {new Date(item.timestamp).toLocaleString()}
                                                            </span>
                                                            <button 
                                                                onClick={(e) => deleteHistoryItem(e, item.id)}
                                                                className="text-gray-300 hover:text-red-500 p-1.5 rounded-full hover:bg-red-50 transition-colors z-10 opacity-0 group-hover:opacity-100"
                                                                title="åˆªé™¤æ­¤ç´€éŒ„"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </div>
                                                        
                                                        <h4 className="font-bold text-base text-gray-800 line-clamp-2 mb-3 group-hover:text-brand-700 leading-snug">
                                                            {item.params.input || "(ç„¡æ¨™é¡Œè¼¸å…¥)"}
                                                        </h4>
                                                        
                                                        <div className="mt-auto flex flex-wrap gap-2">
                                                            {item.params.productType && (
                                                                <span className="text-sm px-2 py-1 bg-blue-50 text-blue-600 rounded border border-blue-100 font-medium">
                                                                    {item.params.productType}
                                                                </span>
                                                            )}
                                                            {item.params.hasImage && (
                                                                <span className="text-sm px-2 py-1 bg-purple-50 text-purple-600 rounded border border-purple-100 font-medium flex items-center gap-1">
                                                                    <ImageIcon className="w-3 h-3"/> é™„åœ–
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* VIEW: HOME (Input Form) */}
                    {view === 'home' && (
                        <div className="w-full max-w-3xl mx-auto p-6 md:p-12 min-h-[90vh] flex flex-col justify-center items-center animate-in fade-in zoom-in-95 duration-300">
                            
                            <div className="w-full flex flex-col justify-center space-y-8">
                                
                                {/* Branding Header */}
                                <div className="flex flex-col gap-5 items-center text-center">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg shadow-brand-200">
                                            <LayoutTemplate className="w-7 h-7 text-white" />
                                        </div>
                                        <h1 className="text-3xl font-bold text-neutral-900 tracking-tight">UX Flow Checklist</h1>
                                    </div>
                                    <p className="text-neutral-500 text-base leading-relaxed max-w-lg">
                                        å°ˆç‚ºè¨­è¨ˆå¸«æ‰“é€ çš„æ™ºèƒ½æª¢æŸ¥å™¨ã€‚<br/>è¼¸å…¥éœ€æ±‚æˆ–è²¼ä¸Šæˆªåœ–ï¼Œç¬é–“è£œå…¨éºæ¼çš„ UX ç‹€æ…‹ã€‚
                                    </p>
                                </div>

                                {/* Main Input Card */}
                                <div className="bg-white border border-gray-100 shadow-xl shadow-brand-50/50 rounded-3xl p-8 space-y-8 w-full">
                                    
                                    {/* Main Input Area */}
                                    <div className="space-y-4">
                                        <label className="block text-base font-bold text-neutral-800 ml-1">
                                            ä½ æƒ³ç¹ªè£½ä»€éº¼åŠŸèƒ½æµç¨‹ï¼Ÿ
                                        </label>
                                        <div 
                                            className={`relative group rounded-xl transition-all duration-300 ${
                                                isDragging 
                                                ? 'bg-brand-50 border-2 border-brand-500' 
                                                : 'bg-white border border-gray-200 shadow-sm hover:border-brand-300 focus-within:border-brand-600'
                                            }`}
                                            onDragOver={handleDragOver}
                                            onDragLeave={handleDragLeave}
                                            onDrop={handleDrop}
                                            onPaste={handlePaste}
                                        >
                                            <textarea
                                                value={input}
                                                onChange={(e) => setInput(e.target.value)}
                                                placeholder="ä¾‹ï¼šç¶å®šæ‰‹æ©Ÿè™Ÿç¢¼æµç¨‹... (æ”¯æ´ Ctrl+V è²¼ä¸Šæˆªåœ–)"
                                                className="w-full p-4 pb-14 rounded-xl border-none bg-transparent focus:ring-0 outline-none resize-none min-h-[160px] text-base placeholder-neutral-400"
                                                onKeyDown={(e) => {
                                                    // Change to Cmd/Ctrl + Enter for submit, allowing Enter for new lines
                                                    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                                                        e.preventDefault();
                                                        generateFlows();
                                                    }
                                                }}
                                            />
                                            
                                            {/* Image Preview & Actions */}
                                            <div className="absolute bottom-3 left-3 right-3 flex items-center justify-between pointer-events-none">
                                                <div className="pointer-events-auto">
                                                    {image ? (
                                                        <div className="relative group/image">
                                                            <img src={image} alt="Preview" className="h-12 w-auto rounded border border-gray-200 shadow-sm" />
                                                            <button onClick={removeImage} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow hover:bg-red-600"><X className="w-3 h-3"/></button>
                                                        </div>
                                                    ) : (
                                                        <button 
                                                            onClick={() => fileInputRef.current?.click()}
                                                            className="p-2 text-neutral-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                                                            title="ä¸Šå‚³åœ–ç‰‡"
                                                        >
                                                            <ImageIcon className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Suggestion Chips */}
                                        <div className="flex flex-wrap gap-2 items-center">
                                            {['ç¶å®šæ‰‹æ©Ÿè™Ÿç¢¼', 'é‡è¨­å¯†ç¢¼æµç¨‹', 'è³¼ç‰©è»Šçµå¸³', 'å€‹äººè³‡æ–™ç·¨è¼¯'].map(chip => (
                                                <button 
                                                    key={chip}
                                                    onClick={() => setInput(chip)}
                                                    className="px-3 py-1 text-base bg-gray-50 border border-gray-100 rounded-full text-neutral-600 hover:border-brand-200 hover:bg-brand-50 hover:text-brand-700 transition-all"
                                                >
                                                    {chip}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Collapsible Advanced Settings */}
                                    <div className="pt-2">
                                        <button 
                                            onClick={() => setShowAdvanced(!showAdvanced)}
                                            className="flex items-center gap-1.5 text-base font-medium text-gray-400 hover:text-brand-600 transition-colors py-2 ml-1"
                                        >
                                            <span>é€²éšè¨­å®š</span>
                                            {showAdvanced ? <ChevronUp className="w-3.5 h-3.5" /> : <ChevronDown className="w-3.5 h-3.5" />}
                                        </button>
                                        
                                        {showAdvanced && (
                                            <div className="mt-2 grid grid-cols-2 gap-6 animate-in fade-in slide-in-from-top-2">
                                                {[
                                                    { label: 'è¨­è¨ˆç›®çš„ (Design Goal)', val: designGoal, set: setDesignGoal, ph: 'ä¾‹ï¼šæ¸›å°‘å®¢æœæŠ•è¨´ã€æå‡è¨»å†Šè½‰æ›ç‡...', fullWidth: true },
                                                    { label: 'ç”¢å“é¡å‹', val: productType, set: setProductType, ph: 'B2B SaaS, é›»å•†...' },
                                                    { label: 'ç›®æ¨™æ—ç¾¤', val: audience, set: setAudience, ph: 'è€å¹´äºº, å°ˆæ¥­äººå£«...' },
                                                    { label: 'æ“ä½œå¹³å°', val: platform, set: setPlatform, ph: 'Mobile, Web...' },
                                                    { label: 'ç‰¹æ®Šé™åˆ¶', val: constraints, set: setConstraints, ph: 'å¼±ç¶², é«˜è³‡å®‰...' },
                                                ].map((field, idx) => (
                                                    <div key={idx} className={field.fullWidth ? 'col-span-2' : ''}>
                                                        <label className="block text-base font-medium text-neutral-500 mb-1 ml-1">
                                                            {field.label}
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={field.val}
                                                            onChange={(e) => field.set(e.target.value)}
                                                            placeholder={field.ph}
                                                            className="w-full px-3 py-2 text-base rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Primary Action Button */}
                                    <div className="pt-2">
                                        <button
                                                onClick={generateFlows}
                                                disabled={loading || (!input.trim() && !image)}
                                                className={`
                                                    w-full py-4 rounded-xl flex items-center justify-center gap-3 font-bold text-lg transition-all duration-300
                                                    ${loading || (!input.trim() && !image)
                                                        ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                        : 'bg-brand-600 text-white shadow-xl shadow-brand-200 hover:bg-brand-700 hover:shadow-2xl hover:-translate-y-1 active:translate-y-0'
                                                    }
                                                `}
                                            >
                                                <div className="w-6 h-6 flex items-center justify-center flex-shrink-0">
                                                    {loading ? (
                                                        <Loader2 className="w-full h-full animate-spin" />
                                                    ) : (
                                                        <Sparkles className="w-full h-full overflow-visible" />
                                                    )}
                                                </div>
                                                <div>{loading ? 'æ­£åœ¨åˆ†æ UX æµç¨‹...' : 'ç”Ÿæˆæ¸…å–®'}</div>
                                            </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* VIEW: RESULT (Design Report) */}
                    {view === 'result' && result && (
                        <div key={resultKey} className="w-full min-h-screen bg-white animate-in slide-in-from-right-8 duration-300">
                            
                            {/* Sticky Navbar */}
                            <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200 px-6 py-4">
                                <div className="max-w-6xl mx-auto flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={handleBackToHome}
                                            className="flex items-center gap-1 text-neutral-600 hover:text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-all font-medium text-base"
                                        >
                                            <ArrowLeft className="w-4 h-4" />
                                            <span>è¿”å›æŸ¥è©¢</span>
                                        </button>
                                        <div className="h-5 w-px bg-gray-300"></div>
                                        <h2 className="text-lg font-bold text-neutral-900">
                                            è¨­è¨ˆåˆ†æå ±å‘Š
                                        </h2>

                                        {/* Progress Indicator Badge */}
                                        {progressStats.total > 0 && (
                                            <div className="hidden md:flex flex-col gap-1.5 ml-6 min-w-[140px] animate-in fade-in slide-in-from-left-4">
                                                <div className="flex items-center justify-between text-sm leading-none">
                                                    <span className="font-medium text-gray-400">æª¢æŸ¥é€²åº¦</span>
                                                    <span className="font-bold text-brand-600 tracking-wider">
                                                        {progressStats.checked} <span className="text-gray-300 font-normal">/</span> {progressStats.total}
                                                    </span>
                                                </div>
                                                <div className="w-full h-1.5 bg-gray-100 rounded-full overflow-hidden">
                                                    <div 
                                                        className="h-full bg-brand-500 rounded-full transition-all duration-500 ease-out shadow-[0_0_8px_rgba(139,92,246,0.3)]" 
                                                        style={{ width: `${progressStats.percent}%` }}
                                                    ></div>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <button
                                        onClick={copyToClipboard}
                                        className="flex items-center gap-2 text-base font-medium px-4 py-2 bg-white border border-gray-200 rounded-lg hover:border-brand-300 hover:text-brand-600 hover:shadow-sm transition-all"
                                    >
                                        {copied ? <Check className="w-4 h-4" /> : <Clipboard className="w-4 h-4" />}
                                        {copied ? 'å·²è¤‡è£½' : 'è¤‡è£½å ±å‘Š'}
                                    </button>
                                </div>
                            </div>

                            <div className="max-w-6xl mx-auto px-6 py-8">
                                {/* Tabs */}
                                <div className="bg-gray-100/50 p-1 rounded-xl inline-flex mb-8 border border-gray-200">
                                    {[
                                        { id: 'details', label: 'æµç¨‹ç´°ç¯€ (Process Details)' },
                                        { id: 'impacts', label: 'è·¨é é¢å½±éŸ¿ (Impacts)' },
                                        { id: 'userflow', label: 'User Flow' },
                                        { id: 'references', label: 'ç«¶å“åƒè€ƒ' }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center justify-center px-6 py-2.5 text-base font-medium rounded-lg transition-all ${
                                                activeTab === tab.id 
                                                ? 'bg-white text-brand-700 shadow-sm ring-1 ring-black/5' 
                                                : 'text-neutral-500 hover:text-neutral-900 hover:bg-gray-200/50'
                                            }`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>

                                {/* Content Area */}
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 min-h-[500px]">
                                    
                                    {/* 1. DETAILS TAB: New Step-based Layout vs Legacy Layout */}
                                    {activeTab === 'details' && (
                                        <>
                                            {result.steps ? (
                                                <div className="flex flex-col gap-6">
                                                    {/* Step Tabs Navigation - Changed to Grid Layout */}
                                                    <div className="bg-gray-50/80 p-4 rounded-2xl border border-gray-100">
                                                        <div className="flex justify-between items-center mb-3 px-1">
                                                            <h3 className="text-sm font-bold text-gray-500 uppercase tracking-wider">æµç¨‹æ­¥é©Ÿç¸½è¦½</h3>
                                                            <span className="text-xs text-gray-400">é»æ“Šåˆ‡æ›æ­¥é©Ÿ</span>
                                                        </div>
                                                        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                                                            {result.steps.map((step, idx) => {
                                                                const isActive = activeStepId === step.id;
                                                                // Check completion status for this step
                                                                // Updated to include user_negative_flow in count
                                                                const totalItems = (step.happy_path?.length || 0) + (step.negative_path?.length || 0) + (step.user_negative_flow?.length || 0) + (step.edge_cases?.length || 0) + (step.system_states?.length || 0);
                                                                let checkedCount = 0;
                                                                ['happy_path', 'negative_path', 'user_negative_flow', 'edge_cases', 'system_states'].forEach(cat => {
                                                                    if(step[cat]) step[cat].forEach(i => { if(checkedItems[i.id]) checkedCount++; });
                                                                });
                                                                const isComplete = totalItems > 0 && checkedCount === totalItems;

                                                                return (
                                                                    <button
                                                                        key={step.id || idx}
                                                                        onClick={() => setActiveStepId(step.id)}
                                                                        className={`
                                                                            relative flex items-center gap-2 px-3 py-2.5 rounded-lg text-sm font-medium transition-all text-left border
                                                                            ${isActive 
                                                                                ? 'bg-white border-brand-500 text-brand-700 ring-2 ring-brand-100 shadow-sm z-10' 
                                                                                : 'bg-white border-gray-200 text-gray-600 hover:border-brand-300 hover:text-brand-600 hover:shadow-sm'
                                                                            }
                                                                        `}
                                                                    >
                                                                        <span className={`
                                                                            w-5 h-5 rounded-full flex-shrink-0 flex items-center justify-center text-xs font-bold transition-colors
                                                                            ${isActive ? 'bg-brand-600 text-white' : 'bg-gray-100 text-gray-500'}
                                                                            ${isComplete && !isActive ? 'bg-green-100 text-green-600' : ''}
                                                                        `}>
                                                                            {isComplete && !isActive ? <Check className="w-3 h-3" /> : (idx + 1)}
                                                                        </span>
                                                                        <span className="truncate flex-1">
                                                                            {step.title.replace(/^æ­¥é©Ÿ \d+[:ï¼š]\s*/, '')}
                                                                        </span>
                                                                        
                                                                        {isComplete && isActive && (
                                                                            <CheckCircle className="w-4 h-4 text-brand-600 flex-shrink-0" />
                                                                        )}
                                                                    </button>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>

                                                    {/* Selected Step Content */}
                                                    <div className="animate-in fade-in zoom-in-95 duration-300">
                                                        {result.steps.map((step, idx) => {
                                                            if (step.id !== activeStepId) return null;
                                                            
                                                            // Navigation logic
                                                            const prevStep = idx > 0 ? result.steps[idx - 1] : null;
                                                            const nextStep = idx < result.steps.length - 1 ? result.steps[idx + 1] : null;

                                                            return (
                                                                <div key={step.id} className="flex flex-col gap-6">
                                                                    <StepCard 
                                                                        step={step}
                                                                        checkedItems={checkedItems}
                                                                        toggleCheck={toggleCheck}
                                                                    />
                                                                    
                                                                    {/* Bottom Navigation Buttons */}
                                                                    <div className="flex justify-between items-center px-2">
                                                                        {prevStep ? (
                                                                            <button 
                                                                                onClick={() => {
                                                                                    setActiveStepId(prevStep.id);
                                                                                    window.scrollTo({ top: 100, behavior: 'smooth' });
                                                                                }}
                                                                                className="flex items-center gap-2 text-gray-500 hover:text-brand-600 px-4 py-2 rounded-lg hover:bg-gray-100 transition-colors"
                                                                            >
                                                                                <ArrowLeft className="w-4 h-4" />
                                                                                <span className="text-sm font-medium">ä¸Šä¸€æ­¥ï¼š{prevStep.title.replace(/^æ­¥é©Ÿ \d+[:ï¼š]\s*/, '')}</span>
                                                                            </button>
                                                                        ) : <div></div>}

                                                                        {nextStep ? (
                                                                            <button 
                                                                                onClick={() => {
                                                                                    setActiveStepId(nextStep.id);
                                                                                    window.scrollTo({ top: 100, behavior: 'smooth' });
                                                                                }}
                                                                                className="flex items-center gap-2 text-white bg-neutral-900 hover:bg-brand-600 px-5 py-2.5 rounded-lg shadow-md hover:shadow-lg transition-all"
                                                                            >
                                                                                <span className="text-sm font-bold">ä¸‹ä¸€æ­¥ï¼š{nextStep.title.replace(/^æ­¥é©Ÿ \d+[:ï¼š]\s*/, '')}</span>
                                                                                <ArrowLeft className="w-4 h-4 rotate-180" />
                                                                            </button>
                                                                        ) : (
                                                                            <button 
                                                                                onClick={() => setActiveTab('impacts')}
                                                                                className="flex items-center gap-2 text-brand-600 bg-brand-50 hover:bg-brand-100 px-5 py-2.5 rounded-lg transition-colors"
                                                                            >
                                                                                <span className="text-sm font-bold">æª¢æŸ¥è·¨é é¢å½±éŸ¿</span>
                                                                                <ArrowLeft className="w-4 h-4 rotate-180" />
                                                                            </button>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ) : (
                                                /* Legacy Layout for old history items */
                                                <div className="space-y-6">
                                                    <div className="flex flex-nowrap overflow-x-auto gap-8 border-b border-gray-200 no-scrollbar">
                                                        {detailTabs.map((tab) => {
                                                            const isActive = activeDetailTab === tab.id;
                                                            return (
                                                                <button
                                                                    key={tab.id}
                                                                    onClick={() => setActiveDetailTab(tab.id)}
                                                                    className={`
                                                                        group flex items-center gap-2 px-1 py-4 text-base font-medium transition-all border-b-2 whitespace-nowrap
                                                                        ${isActive 
                                                                            ? `${tab.borderActive} ${tab.textActive}`
                                                                            : `border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300`
                                                                        }
                                                                    `}
                                                                >
                                                                    <tab.icon className={`w-4 h-4 ${isActive ? 'currentColor' : 'text-gray-400 group-hover:text-gray-500'}`} />
                                                                    {tab.label}
                                                                </button>
                                                            )
                                                        })}
                                                    </div>
                                                    <div className="min-h-[400px] flex flex-col">
                                                        {detailTabs.map(tab => {
                                                            if (activeDetailTab !== tab.id) return null;
                                                            return (
                                                                <div key={tab.id} className="animate-in fade-in slide-in-from-right-8 duration-300 flex-1">
                                                                    <CategoryCard
                                                                        title={tab.fullLabel}
                                                                        icon={<tab.icon className={`w-6 h-6 ${tab.iconColor}`} />}
                                                                        items={result[tab.id]}
                                                                        checkedItems={checkedItems}
                                                                        toggleCheck={toggleCheck}
                                                                    />
                                                                </div>
                                                            )
                                                        })}
                                                    </div>
                                                </div>
                                            )}
                                        </>
                                    )}

                                    {/* 2. IMPACTS TAB (New) or Legacy fallback */}
                                    {activeTab === 'impacts' && (
                                        <div className="grid grid-cols-1 gap-6">
                                            <CategoryCard 
                                                title="è·¨é é¢å½±éŸ¿ (Cross-page Impacts)" 
                                                icon={<Network className="w-6 h-6 text-orange-500" />}
                                                items={result.cross_page_impacts} 
                                                checkedItems={checkedItems}
                                                toggleCheck={toggleCheck}
                                            />
                                        </div>
                                    )}

                                    {/* 3. USER FLOW TAB */}
                                    {activeTab === 'userflow' && result.user_flow_mermaid && (
                                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                            <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50/50">
                                                <div className="flex items-center gap-2 pl-2">
                                                    <div className="flex bg-white p-1 rounded-lg border border-gray-200 shadow-sm">
                                                        <button 
                                                            onClick={() => setShowDiagram(true)}
                                                            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-base font-medium transition-all ${showDiagram ? 'bg-brand-50 text-brand-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                                        >
                                                            <Image className="w-4 h-4"/> é è¦½åœ–è¡¨
                                                        </button>
                                                        <button 
                                                            onClick={() => setShowDiagram(false)}
                                                            className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-base font-medium transition-all ${!showDiagram ? 'bg-brand-50 text-brand-700 shadow-sm' : 'text-gray-500 hover:text-gray-700'}`}
                                                        >
                                                            <CodeIcon className="w-4 h-4"/> åŸå§‹ç¢¼
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                <div className="flex items-center gap-2">
                                                    <a 
                                                        href={getMermaidLiveUrl(result.user_flow_mermaid)}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex items-center gap-1.5 text-base text-neutral-600 hover:text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-colors border border-transparent hover:border-brand-200"
                                                    >
                                                        <ExternalLink className="w-3.5 h-3.5" />
                                                        å‰å¾€ Mermaid Live
                                                    </a>
                                                    <div className="h-4 w-px bg-gray-300 mx-1"></div>
                                                    <button
                                                        onClick={copyMermaid}
                                                        className="flex items-center gap-1.5 text-base text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-colors"
                                                    >
                                                        {mermaidCopied ? <Check className="w-3.5 h-3.5" /> : <Clipboard className="w-3.5 h-3.5" />}
                                                        {mermaidCopied ? 'å·²è¤‡è£½' : 'è¤‡è£½ä»£ç¢¼'}
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-white min-h-[400px]">
                                                {showDiagram ? (
                                                     <MermaidDiagram code={result.user_flow_mermaid} />
                                                ) : (
                                                    <div className="bg-gray-50 p-0 overflow-hidden h-full">
                                                        <pre className="font-mono text-base text-gray-600 w-full overflow-auto p-6 bg-gray-50/50 min-h-[300px]">
                                                            {result.user_flow_mermaid}
                                                        </pre>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}

                                    {/* 4. REFERENCES TAB */}
                                    {activeTab === 'references' && (
                                        <div className="grid grid-cols-1 gap-6">
                                            <CategoryCard 
                                                title="ç«¶å“åƒè€ƒ (Competitor References)" 
                                                icon={<Globe className="w-6 h-6 text-indigo-500" />}
                                                items={result.competitor_references} 
                                                checkedItems={checkedItems}
                                                toggleCheck={toggleCheck}
                                                noCheckbox={true}
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Toast Notification */}
                    {toast && (
                        <div className={`fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-lg border flex items-center gap-3 animate-in slide-in-from-bottom-4 z-50 ${
                            toast.type === 'error' 
                                ? 'bg-red-50 text-red-600 border-red-100' 
                                : 'bg-neutral-900 text-white border-neutral-800'
                        }`}>
                            {toast.type === 'error' ? <AlertTriangle className="w-5 h-5" /> : <CheckCircle className="w-5 h-5" />}
                            <span className="font-medium">{toast.message}</span>
                        </div>
                    )}
                </div>
            );
        }

        // New Component: Step Card for Process-based View
        function StepCard({ step, checkedItems, toggleCheck }) {
            const sections = [
                { key: 'happy_path', label: 'æ­£å‘æµç¨‹ (Happy Path)', color: 'text-green-700' },
                { key: 'user_negative_flow', label: 'è² å‘æµç¨‹ (Negative Actions)', color: 'text-orange-700' },
                { key: 'negative_path', label: 'éŒ¯èª¤æµç¨‹ (Error States)', color: 'text-red-700' },
                { key: 'edge_cases', label: 'æ¥µé™èˆ‡é‚Šç•Œ (Edge Cases)', color: 'text-purple-700' },
                { key: 'system_states', label: 'ç³»çµ±ç‹€æ…‹ (System States)', color: 'text-blue-700' },
            ];

            return (
                <div className="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden hover:shadow-md transition-shadow">
                    <div className="bg-gray-50/50 px-6 py-4 border-b border-gray-100">
                        <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2">
                            <span className="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center text-base font-bold shadow-sm">
                                {step.id.replace(/\D/g, '') || '#'}
                            </span>
                            {step.title}
                        </h3>
                    </div>
                    {/* Layout changed to vertical stack (flex-col) for better reading flow */}
                    <div className="p-6 flex flex-col gap-6">
                        {sections.map(section => {
                            const items = step[section.key];
                            if (!items || items.length === 0) return null;
                            
                            return (
                                <div key={section.key} className="space-y-3">
                                    {/* Section Header with clearer visual separation - Removed Icons */}
                                    <div className="flex items-center gap-2.5 pb-2 border-b border-gray-100">
                                        <h4 className={`text-base font-bold tracking-wide ${section.color}`}>
                                            {section.label}
                                        </h4>
                                    </div>
                                    
                                    {/* Items List - Compact List Style (No Cards) */}
                                    <div className="space-y-1 pl-1">
                                        {items.map((item) => {
                                            const isChecked = checkedItems[item.id] || false;
                                            return (
                                                <div 
                                                    key={item.id}
                                                    onClick={() => toggleCheck(item.id)}
                                                    className={`
                                                        group flex items-start gap-3 cursor-pointer py-2 px-2 rounded-lg transition-all
                                                        ${isChecked 
                                                            ? 'opacity-50' 
                                                            : 'hover:bg-gray-50'
                                                        }
                                                    `}
                                                >
                                                    <div className={`
                                                        mt-0.5 w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all duration-200
                                                        ${isChecked 
                                                            ? 'bg-neutral-800 border-neutral-800' 
                                                            : 'border-gray-300 bg-white group-hover:border-brand-500'
                                                        }
                                                    `}>
                                                        {isChecked && <Check className="w-3.5 h-3.5 text-white" />}
                                                    </div>
                                                    <div className="flex-1">
                                                        <span className={`text-base font-bold block mb-0.5 ${isChecked ? 'line-through text-gray-500' : 'text-gray-800'}`}>
                                                            {item.title}
                                                        </span>
                                                        <span className="text-gray-500 text-sm leading-relaxed block">
                                                            {item.desc}
                                                        </span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // Legacy Component (Kept for old history compatibility)
        function CategoryCard({ title, icon, items, checkedItems, toggleCheck, noCheckbox = false }) {
            if (!items || items.length === 0) return null;

            return (
                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden h-full">
                    <div className="px-8 pt-8 pb-4 flex items-center gap-4">
                        <div className="p-2.5 bg-gray-50 rounded-xl">
                            {icon}
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-neutral-900">{title}</h3>
                        </div>
                        <span className="ml-auto text-sm font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                            {items.length} é …ç›®
                        </span>
                    </div>

                    <div className="px-8 pb-8 pt-2 space-y-6">
                        {items.map((item, idx) => {
                            const isChecked = checkedItems[item.id] || false;
                            return (
                                <div 
                                    key={item.id || idx}
                                    onClick={() => !noCheckbox && toggleCheck(item.id)}
                                    className={`group flex items-start gap-4 ${!noCheckbox ? 'cursor-pointer' : ''}`}
                                >
                                    {!noCheckbox && (
                                        <div className={`
                                            mt-1 w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all duration-200
                                            ${isChecked 
                                                ? 'bg-neutral-800 border-neutral-800' 
                                                : 'border-gray-300 bg-white group-hover:border-brand-500'
                                            }
                                        `}>
                                            {isChecked && <Check className="w-3.5 h-3.5 text-white" />}
                                        </div>
                                    )}
                                    
                                    <div className={`flex-1 transition-all duration-300 ${isChecked ? 'opacity-40' : 'opacity-100'}`}>
                                        <h4 className={`text-base font-bold mb-1.5 transition-colors ${isChecked ? 'text-neutral-500 line-through decoration-gray-300' : 'text-neutral-800 group-hover:text-brand-700'}`}>
                                            {item.title}
                                        </h4>
                                        <p className="text-base text-neutral-500 leading-relaxed">
                                            {item.desc}
                                        </p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UXFlowMaster />);
    </script>
</body>
</html>
