<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UX Flow Master - ÂÖ®Êñπ‰ΩçÊµÅÁ®ãÊ™¢Êü•Âô®</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed', // Primary Vivid Purple
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        },
                        neutral: {
                            900: '#111827', // High contrast text
                            500: '#6b7280', // Secondary text
                            100: '#f3f4f6', // Light gray bg
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
                        'in': 'fadeIn 0.3s ease-out',
                        'slide-in-right': 'slideInRight 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
                    },
                    keyframes: {
                        fadeInUp: {
                            'from': { opacity: '0', transform: 'translateY(20px)' },
                            'to': { opacity: '1', transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        },
                        slideInRight: {
                            'from': { transform: 'translateX(100%)' },
                            'to': { transform: 'translateX(0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Custom scrollbar for code blocks */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f5f3ff;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #ddd6fe;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #c4b5fd;
        }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-900 antialiased selection:bg-brand-200 selection:text-brand-900">
    <div id="root"></div>

    <script type="text/babel">
        // API Key is injected by the environment or can be set manually for local testing
        const apiKey = ""; 

        const { useState, useEffect, useRef } = React;
        
        // --- Icons Components (SVG) - Minimalist Line Style ---
        const IconBase = ({ children, className, onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick}>
                {children}
            </svg>
        );

        const LayoutTemplate = ({ className }) => (
            <IconBase className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="9" y2="21"/></IconBase>
        );
        const Loader2 = ({ className }) => (
            <IconBase className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>
        );
        const Sparkles = ({ className }) => (
            <IconBase className={className}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L12 3Z"/></IconBase>
        );
        const AlertTriangle = ({ className }) => (
            <IconBase className={className}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>
        );
        const CheckCircle = ({ className }) => (
            <IconBase className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>
        );
        const Clipboard = ({ className }) => (
            <IconBase className={className}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconBase>
        );
        const Check = ({ className }) => (
            <IconBase className={className}><polyline points="20 6 9 17 4 12"/></IconBase>
        );
        const Zap = ({ className }) => (
            <IconBase className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>
        );
        const Box = ({ className }) => (
            <IconBase className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>
        );
        const RefreshCw = ({ className }) => (
            <IconBase className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>
        );
        const Globe = ({ className }) => (
            <IconBase className={className}><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></IconBase>
        );
        const ChevronDown = ({ className }) => (
            <IconBase className={className}><polyline points="6 9 12 15 18 9"/></IconBase>
        );
        const ChevronUp = ({ className }) => (
            <IconBase className={className}><polyline points="18 15 12 9 6 15"/></IconBase>
        );
        const Users = ({ className }) => (
            <IconBase className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></IconBase>
        );
        const Smartphone = ({ className }) => (
            <IconBase className={className}><rect width="14" height="20" x="5" y="2" rx="2" ry="2"/><path d="M12 18h.01"/></IconBase>
        );
        const ShieldAlert = ({ className }) => (
            <IconBase className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></IconBase>
        );
        const Briefcase = ({ className }) => (
            <IconBase className={className}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>
        );
        const Network = ({ className }) => (
            <IconBase className={className}><rect x="16" y="16" width="6" height="6" rx="1"/><rect x="2" y="16" width="6" height="6" rx="1"/><rect x="9" y="2" width="6" height="6" rx="1"/><path d="M5 16v-3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3"/><path d="M12 12V8"/></IconBase>
        );
        const ExternalLink = ({ className }) => (
            <IconBase className={className}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></IconBase>
        );
        const X = ({ className, onClick }) => (
            <IconBase className={className} onClick={onClick}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>
        );
        const ImageIcon = ({ className }) => (
            <IconBase className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></IconBase>
        );
        const ArrowLeft = ({ className }) => (
            <IconBase className={className}><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></IconBase>
        );
        const Target = ({ className }) => (
            <IconBase className={className}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>
        );
        // History Icons
        const HistoryIcon = ({ className }) => (
            <IconBase className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></IconBase>
        );
        const Trash2 = ({ className }) => (
            <IconBase className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>
        );
        const Clock = ({ className }) => (
             <IconBase className={className}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></IconBase>
        );


        // --- Helper Function for JSON Parsing ---
        const parseGeminiResponse = (text) => {
            try {
                return JSON.parse(text);
            } catch (e) {
                const firstBrace = text.indexOf('{');
                const lastBrace = text.lastIndexOf('}');
                
                if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
                    const jsonString = text.substring(firstBrace, lastBrace + 1);
                    try {
                        return JSON.parse(jsonString);
                    } catch (e2) {
                        console.error("Failed to parse extracted JSON:", e2);
                        throw e;
                    }
                } else {
                    throw e;
                }
            }
        };

        // --- Main Component ---
        function UXFlowMaster() {
            const [view, setView] = useState('home'); // 'home' | 'result'
            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [copied, setCopied] = useState(false);
            const [mermaidCopied, setMermaidCopied] = useState(false);
            const [checkedItems, setCheckedItems] = useState({});
            const [activeTab, setActiveTab] = useState('details');
            const [activeDetailTab, setActiveDetailTab] = useState('happy_path'); 
            
            // Advanced Settings State
            const [showAdvanced, setShowAdvanced] = useState(false);
            const [audience, setAudience] = useState('');
            const [platform, setPlatform] = useState('');
            const [constraints, setConstraints] = useState('');
            const [productType, setProductType] = useState('');
            const [designGoal, setDesignGoal] = useState('');

            // Image Upload State
            const [image, setImage] = useState(null); 
            const [isDragging, setIsDragging] = useState(false);
            const fileInputRef = useRef(null);
            
            // History State
            const [history, setHistory] = useState([]);
            const [showHistory, setShowHistory] = useState(false);

            // Load history from local storage on mount
            useEffect(() => {
                const savedHistory = localStorage.getItem('ux_flow_history');
                if (savedHistory) {
                    try {
                        setHistory(JSON.parse(savedHistory));
                    } catch (e) {
                        console.error("Failed to parse history", e);
                    }
                }
            }, []);

            useEffect(() => {
                if (result) {
                    setCheckedItems({});
                    setActiveTab('details');
                    setActiveDetailTab('happy_path'); 
                    setView('result'); // Switch to result view
                    window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
                }
            }, [result]);

            const toggleCheck = (id) => {
                setCheckedItems(prev => ({
                    ...prev,
                    [id]: !prev[id]
                }));
            };

            // --- History Functions ---
            const saveToHistory = (newResult, params) => {
                const newItem = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    result: newResult,
                    params: {
                        input: params.input,
                        audience: params.audience,
                        platform: params.platform,
                        constraints: params.constraints,
                        productType: params.productType,
                        designGoal: params.designGoal,
                        // Note: deliberately NOT saving the base64 image to history to prevent LocalStorage quota overflow
                        hasImage: !!params.image 
                    }
                };

                const updatedHistory = [newItem, ...history].slice(0, 20); // Keep last 20 items
                setHistory(updatedHistory);
                localStorage.setItem('ux_flow_history', JSON.stringify(updatedHistory));
            };

            const loadHistoryItem = (item) => {
                const { params, result } = item;
                setInput(params.input || '');
                setAudience(params.audience || '');
                setPlatform(params.platform || '');
                setConstraints(params.constraints || '');
                setProductType(params.productType || '');
                setDesignGoal(params.designGoal || '');
                setImage(null); // Clear image as we don't store it
                
                setResult(result);
                // useEffect will handle view switch to 'result'
                setShowHistory(false);
                setShowAdvanced(true); // Open advanced settings to show loaded params
            };

            const deleteHistoryItem = (e, id) => {
                e.stopPropagation();
                const updatedHistory = history.filter(item => item.id !== id);
                setHistory(updatedHistory);
                localStorage.setItem('ux_flow_history', JSON.stringify(updatedHistory));
            };

            const clearHistory = () => {
                if(confirm("Á¢∫ÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊ≠∑Âè≤Á¥ÄÈåÑÂóéÔºü")) {
                    setHistory([]);
                    localStorage.removeItem('ux_flow_history');
                }
            };

            // --- Image Handling Functions ---
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) processFile(file);
            };

            const handleDragOver = (e) => {
                e.preventDefault();
                setIsDragging(true);
            };

            const handleDragLeave = (e) => {
                e.preventDefault();
                setIsDragging(false);
            };

            const handleDrop = (e) => {
                e.preventDefault();
                setIsDragging(false);
                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    processFile(file);
                }
            };

            const handlePaste = (e) => {
                const items = e.clipboardData.items;
                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf('image') !== -1) {
                        const file = items[i].getAsFile();
                        processFile(file);
                        break;
                    }
                }
            };

            const processFile = (file) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64String = reader.result;
                    setImage(base64String);
                };
                reader.readAsDataURL(file);
            };

            const removeImage = () => {
                setImage(null);
                if (fileInputRef.current) fileInputRef.current.value = '';
            };

            const handleBackToHome = () => {
                setView('home');
                window.scrollTo({ top: 0, behavior: 'smooth' });
                // Note: We keep the input state so user can modify it. 
                // If they want to clear, they can delete the text manually.
            };

            const generateFlows = async () => {
                if (!input.trim() && !image) return;
                setLoading(true);
                setError('');
                setResult(null);

                try {
                    let userQueryText = `ÊàëË¶ÅË®≠Ë®àÁöÑÂäüËÉΩÊòØÔºö${input}„ÄÇ`;
                    if (designGoal.trim()) userQueryText += `\nË®≠Ë®àÁõÆÁöÑÔºö${designGoal}„ÄÇ`;
                    if (productType.trim()) userQueryText += `\nÁî¢ÂìÅÈ°ûÂûãÔºö${productType}„ÄÇ`;
                    if (audience.trim()) userQueryText += `\nÁõÆÊ®ôÊóèÁæ§Ôºö${audience}„ÄÇ`;
                    if (platform.trim()) userQueryText += `\nÊìç‰ΩúÂπ≥Âè∞Ôºö${platform}„ÄÇ`;
                    if (constraints.trim()) userQueryText += `\nÁâπÊÆäÈôêÂà∂/ÊÉÖÂ¢ÉÔºö${constraints}„ÄÇ`;
                    
                    if (image) {
                        userQueryText += `\nÈôÑÂúñÊòØÊàëÁõÆÂâçÁöÑ‰ªãÈù¢Ë®≠Ë®àËçâÂúñ/Êà™ÂúñÔºåË´ãÈáùÂ∞çÊ≠§Áï´Èù¢ÂàÜÊûêÂèØËÉΩÁº∫Â§±ÁöÑÊµÅÁ®ãËàáÁãÄÊÖã„ÄÇ`;
                    }

                    userQueryText += `\nË´ãÂàóÂá∫ UI ÊµÅÁ®ãËàáÁãÄÊÖã (ÁêÜÊÉ≥„ÄÅÈåØË™§„ÄÅÊ•µÈôê„ÄÅÁ©∫ÁôΩ„ÄÅËºâÂÖ•)„ÄÅË∑®È†ÅÈù¢ÂΩ±Èüø„ÄÅÊé®Ëñ¶Á´∂ÂìÅÂèÉËÄÉÔºå‰∏¶Áπ™Ë£Ω User Flow„ÄÇ`;

                    const systemPrompt = `
                        ‰Ω†ÊòØ‰∏Ä‰ΩçË≥áÊ∑±ÁöÑ UX/UI Ë®≠Ë®àÂ∏´ËàáÁî¢ÂìÅÁ∂ìÁêÜÂ∞àÂÆ∂„ÄÇ‰Ω†ÁöÑ‰ªªÂãôÊòØÂπ´Âä© UI Ë®≠Ë®àÂ∏´ÊâæÂá∫ÁâπÂÆöÂäüËÉΩÁöÑÊâÄÊúâÊΩõÂú®ÁãÄÊÖãÂíåÊµÅÁ®ã„ÄÇ
                        
                        Ë´ãÈáùÂ∞ç‰ΩøÁî®ËÄÖÁöÑËº∏ÂÖ•ÔºàÂåÖÂê´ÂäüËÉΩÊèèËø∞„ÄÅÊà™Âúñ„ÄÅÁî¢ÂìÅÈ°ûÂûã„ÄÅÁõÆÊ®ôÊóèÁæ§„ÄÅË®≠Ë®àÁõÆÁöÑÁ≠âÔºâÔºåË©≥Á¥∞ÂàóÂá∫ÊâÄÊúâÂøÖÈ†àËÄÉÊÖÆÁöÑÁï´Èù¢ÂíåÁãÄÊÖãÔºå‰∏¶ÁîüÊàê‰∏ÄÂÄã Mermaid.js ÊµÅÁ®ãÂúñ„ÄÇ
                        
                        **Ëã•‰ΩøÁî®ËÄÖÊèê‰æõ‰∫ÜÂúñÁâá**Ôºö
                        1. Ë´ã‰ªîÁ¥∞ÂàÜÊûêÂúñÁâá‰∏≠ÁöÑÂÖÉ‰ª∂Ôºà‰æãÂ¶ÇÔºöÊåâÈàï„ÄÅËº∏ÂÖ•Ê°Ü„ÄÅÂ∞éËà™ÂàóÔºâ„ÄÇ
                        2. Ê†πÊìöÂúñÁâáÂÖßÂÆπÔºåÊåáÂá∫**Ë¶ñË¶∫‰∏äÁº∫Â§±**Êàñ**ÈÇèËºØ‰∏äÈÅ∫Êºè**ÁöÑÁãÄÊÖã„ÄÇ
                        3. ÁµêÂêàÂúñÁâáËàáÊñáÂ≠óÊèèËø∞ÔºåÊèê‰æõÂÆåÊï¥ÁöÑÊîπÂñÑÂª∫Ë≠∞„ÄÇ

                        ÈáçÈªûÁ≠ñÁï•Ôºö
                        1. **Ë®≠Ë®àÁõÆÁöÑ**ÔºöËã•‰ΩøÁî®ËÄÖÊèê‰æõ‰∫ÜË®≠Ë®àÁõÆÁöÑÔºà‰æãÂ¶ÇÊèêÈ´òËΩâÊèõÁéáÔºâÔºåË´ãÂú®Âª∫Ë≠∞‰∏≠ÁâπÂà•Âº∑Ë™øÂ¶Ç‰ΩïÈÅîÊàêÊ≠§ÁõÆÁöÑ„ÄÇ
                        2. **Áî¢ÂìÅÈ°ûÂûã**ÔºöË´ãÊ†πÊìöÁî¢ÂìÅÂ±¨ÊÄßÔºàÂ¶Ç B2B, B2C, SaaS, Â∑•ÂÖ∑È°ûÔºâË™øÊï¥Âª∫Ë≠∞ÁöÑÊ∑±Â∫¶ËàáË§áÈõúÂ∫¶„ÄÇ
                        3. **ÁõÆÊ®ôÊóèÁæ§**ÔºöË´ãÂú® Edge Cases Ëàá Error States ‰∏≠Âä†ÂÖ•ÈáùÂ∞çË©≤ÊóèÁæ§ÁöÑÁâπÊÆäËÄÉÈáè„ÄÇ
                        4. **Ë∑®È†ÅÈù¢ÂΩ±Èüø**ÔºöÂøÖÈ†àÊÄùËÄÉÊ≠§ÂäüËÉΩÂ∞ç„ÄåÂÖ∂‰ªñÈ†ÅÈù¢„ÄçÁöÑÈÄ£ÂãïÂΩ±Èüø„ÄÇ
                        
                        ÂøÖÈ†àÂÆåÊï¥Ë¶ÜËìã‰ª•‰∏ã‰∏ÉÂÄãÈÉ®ÂàÜÔºö
                        1. happy_path: ÁêÜÊÉ≥ÊµÅÁ®ãÔºàHappy PathÔºâ
                        2. negative_path: ÈåØË™§ÊµÅÁ®ãÔºàError StatesÔºâ
                        3. edge_cases: Ê•µÈôêËàáÈÇäÁïåÊÉÖÊ≥ÅÔºàLimit CasesÔºâ
                        4. system_states: Á©∫ÁôΩËàáËºâÂÖ•ÁãÄÊÖãÔºàEmpty & LoadingÔºâ
                        5. cross_page_impacts: Ë∑®È†ÅÈù¢ËàáÂÖ®Â±ÄÂΩ±Èüø (Cross-page Impacts)
                        6. competitor_references: Á´∂ÂìÅÂèÉËÄÉ (Competitor References)
                        7. user_flow_mermaid: ‰∏ÄÂÄãÂÆåÊï¥ÁöÑ Mermaid.js flowchart Â≠ó‰∏≤„ÄÇ
                        
                        Ë´ã‰ª•Âö¥Ê†ºÁöÑ JSON Ê†ºÂºèÂõûÂÇ≥Ôºå‰∏çË¶Å‰ΩøÁî® markdown code blockÔºå‰∏çË¶ÅÊúâ‰ªª‰ΩïË®ªÈáã„ÄÇ
                        Response MUST be valid JSON string only.
                        {
                          "happy_path": [{ "id": "h1", "title": "Ê®ôÈ°å", "desc": "Ë©≥Á¥∞ÊèèËø∞" }],
                          "negative_path": [{ "id": "n1", "title": "Ê®ôÈ°å", "desc": "Ë©≥Á¥∞ÊèèËø∞" }],
                          "edge_cases": [{ "id": "e1", "title": "Ê®ôÈ°å", "desc": "Ë©≥Á¥∞ÊèèËø∞" }],
                          "system_states": [{ "id": "s1", "title": "Ê®ôÈ°å", "desc": "Ë©≥Á¥∞ÊèèËø∞" }],
                          "cross_page_impacts": [{ "id": "c1", "title": "Ê®ôÈ°å", "desc": "Ë©≥Á¥∞ÊèèËø∞" }],
                          "competitor_references": [{ "id": "r1", "title": "Áî¢ÂìÅÂêçÁ®±", "desc": "ÂÄºÂæóÂèÉËÄÉÁöÑË®≠Ë®àÁ¥∞ÁØÄËàáÂéüÂõ†" }],
                          "user_flow_mermaid": "graph TD..."
                        }
                    `;

                    const parts = [{ text: userQueryText }];
                    if (image) {
                        const matches = image.match(/^data:(.+);base64,(.+)$/);
                        if (matches && matches.length === 3) {
                            parts.push({
                                inlineData: {
                                    mimeType: matches[1],
                                    data: matches[2]
                                }
                            });
                        }
                    }

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: parts }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    if (!response.ok) {
                        const errData = await response.json();
                        throw new Error(errData.error?.message || 'API request failed');
                    }

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    
                    const parsedData = parseGeminiResponse(text);
                    setResult(parsedData);
                    
                    // Save to history upon success
                    saveToHistory(parsedData, {
                        input, audience, platform, constraints, productType, designGoal, image
                    });

                } catch (err) {
                    console.error(err);
                    setError('ÁîüÊàêÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇÈåØË™§Ë®äÊÅØ: ' + err.message);
                } finally {
                    setLoading(false);
                }
            };

            const copyToClipboard = () => {
                if (!result) return;
                
                let text = `UX Design Checklist: ${input}\n`;
                if (designGoal) text += `Design Goal: ${designGoal}\n`;
                if (productType) text += `Product Type: ${productType}\n`;
                text += '\n';
                
                const categories = [
                    { key: 'happy_path', label: 'üü¢ ÁêÜÊÉ≥ÊµÅÁ®ã (Happy Path)' },
                    { key: 'negative_path', label: 'üî¥ ÈåØË™§ÊµÅÁ®ã (Error States)' },
                    { key: 'edge_cases', label: '‚ö° Ê•µÈôêËàáÈÇäÁïå (Limit Cases)' },
                    { key: 'system_states', label: '‚ö™ Á©∫ÁôΩËàáËºâÂÖ• (Empty & Loading)' },
                    { key: 'cross_page_impacts', label: 'üîó Ë∑®È†ÅÈù¢ÂΩ±Èüø (Cross-page Impacts)' },
                    { key: 'competitor_references', label: 'üîç Á´∂ÂìÅÂèÉËÄÉ (Competitor References)' }
                ];

                categories.forEach(cat => {
                    if (result[cat.key]) {
                        text += `${cat.label}\n`;
                        result[cat.key].forEach(item => {
                            text += `- [ ] ${item.title}: ${item.desc}\n`;
                        });
                        text += '\n';
                    }
                });

                if (result.user_flow_mermaid) {
                    text += `\nüåä User Flow (Mermaid):\n\`\`\`mermaid\n${result.user_flow_mermaid}\n\`\`\``;
                }

                const el = document.createElement('textarea');
                el.value = text;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    setCopied(true);
                    setTimeout(() => setCopied(false), 2000);
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(el);
            };

            const copyMermaid = () => {
                if (!result?.user_flow_mermaid) return;
                
                const el = document.createElement('textarea');
                el.value = result.user_flow_mermaid;
                document.body.appendChild(el);
                el.select();
                try {
                    document.execCommand('copy');
                    setMermaidCopied(true);
                    setTimeout(() => setMermaidCopied(false), 2000);
                } catch (err) {
                      console.error('Fallback copy failed', err);
                }
                document.body.removeChild(el);
            };

            const getMermaidLiveUrl = (code) => {
                try {
                    const state = {
                      code: code,
                      mermaid: { "theme": "default" },
                      autoSync: true,
                      updateDiagram: true
                    };
                    const json = JSON.stringify(state);
                    const base64 = window.btoa(unescape(encodeURIComponent(json)));
                    return `https://mermaid.live/edit#base64:${base64}`;
                } catch (e) {
                    return "#";
                }
            };

            // Configuration for Detail Sub-tabs
            const detailTabs = [
                { id: 'happy_path', label: 'ÁêÜÊÉ≥ÊµÅÁ®ã', fullLabel: 'ÁêÜÊÉ≥ÊµÅÁ®ã (Happy Path)', icon: Zap, iconColor: 'text-yellow-500', borderColor: 'border-t-yellow-400', bgHover: 'hover:bg-yellow-50', textActive: 'text-yellow-700', borderActive: 'border-yellow-500', bgActive: 'bg-yellow-50' },
                { id: 'negative_path', label: 'ÈåØË™§ÊµÅÁ®ã', fullLabel: 'ÈåØË™§ÊµÅÁ®ã (Error States)', icon: AlertTriangle, iconColor: 'text-red-500', borderColor: 'border-t-red-400', bgHover: 'hover:bg-red-50', textActive: 'text-red-700', borderActive: 'border-red-500', bgActive: 'bg-red-50' },
                { id: 'edge_cases', label: 'Ê•µÈôêÊÉÖÊ≥Å', fullLabel: 'Ê•µÈôêËàáÈÇäÁïå (Limit Cases)', icon: Box, iconColor: 'text-purple-500', borderColor: 'border-t-purple-400', bgHover: 'hover:bg-purple-50', textActive: 'text-purple-700', borderActive: 'border-purple-500', bgActive: 'bg-purple-50' },
                { id: 'system_states', label: 'Á≥ªÁµ±ÁãÄÊÖã', fullLabel: 'Á©∫ÁôΩËàáËºâÂÖ• (Empty & Loading)', icon: RefreshCw, iconColor: 'text-blue-500', borderColor: 'border-t-blue-400', bgHover: 'hover:bg-blue-50', textActive: 'text-blue-700', borderActive: 'border-blue-500', bgActive: 'bg-blue-50' },
                { id: 'cross_page_impacts', label: 'Ë∑®È†ÅÈù¢', fullLabel: 'Ë∑®È†ÅÈù¢ÂΩ±Èüø (Cross-page Impacts)', icon: Network, iconColor: 'text-orange-500', borderColor: 'border-t-orange-400', bgHover: 'hover:bg-orange-50', textActive: 'text-orange-700', borderActive: 'border-orange-500', bgActive: 'bg-orange-50' },
            ];

            return (
                <div className="min-h-screen font-sans flex flex-col items-center relative overflow-x-hidden bg-neutral-50">
                    
                    {/* Top Right Buttons - Only visible on Home */}
                    {view === 'home' && (
                        <div className="fixed top-6 right-6 z-30 flex gap-2">
                             <button 
                                onClick={() => setShowHistory(true)}
                                className="bg-white p-2.5 rounded-xl shadow-md border border-gray-100 text-gray-500 hover:text-brand-600 hover:border-brand-200 transition-all group relative"
                                title="Ê≠∑Âè≤Á¥ÄÈåÑ"
                            >
                                <HistoryIcon className="w-5 h-5" />
                                {history.length > 0 && (
                                    <span className="absolute -top-1 -right-1 flex h-3 w-3">
                                      <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-400 opacity-75"></span>
                                      <span className="relative inline-flex rounded-full h-3 w-3 bg-brand-500"></span>
                                    </span>
                                )}
                            </button>
                        </div>
                    )}

                    {/* Sidebar / Drawer */}
                    {showHistory && (
                        <div className="fixed inset-0 z-50 flex justify-end">
                            {/* Backdrop */}
                            <div className="absolute inset-0 bg-black/20 backdrop-blur-sm animate-in fade-in" onClick={() => setShowHistory(false)}></div>
                            
                            {/* Drawer Content */}
                            <div className="relative w-full max-w-sm bg-white h-full shadow-2xl flex flex-col animate-slide-in-right">
                                <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
                                    <div className="flex items-center gap-2">
                                        <HistoryIcon className="w-5 h-5 text-brand-600" />
                                        <h3 className="font-bold text-lg text-gray-800">Ê≠∑Âè≤Á¥ÄÈåÑ</h3>
                                        <span className="bg-gray-200 text-gray-600 text-xs px-2 py-0.5 rounded-full">{history.length}</span>
                                    </div>
                                    <button onClick={() => setShowHistory(false)} className="p-1 hover:bg-gray-200 rounded-lg text-gray-500">
                                        <X className="w-5 h-5" />
                                    </button>
                                </div>
                                
                                <div className="flex-1 overflow-y-auto p-4 space-y-3 custom-scrollbar">
                                    {history.length === 0 ? (
                                        <div className="text-center py-10 text-gray-400">
                                            <div className="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mx-auto mb-3">
                                                <HistoryIcon className="w-8 h-8 opacity-50" />
                                            </div>
                                            <p>Â∞öÁÑ°Ê≠∑Âè≤Á¥ÄÈåÑ</p>
                                            <p className="text-xs mt-1 opacity-70">ÁîüÊàêÂæåÁöÑÁµêÊûúÊúÉËá™ÂãïÂÑ≤Â≠òÊñºÊ≠§</p>
                                        </div>
                                    ) : (
                                        history.map((item) => (
                                            <div key={item.id} 
                                                onClick={() => loadHistoryItem(item)}
                                                className="group relative bg-white border border-gray-200 rounded-xl p-3 hover:border-brand-300 hover:shadow-md transition-all cursor-pointer"
                                            >
                                                <div className="flex justify-between items-start mb-1">
                                                    <span className="text-xs font-medium text-gray-400 flex items-center gap-1">
                                                        <Clock className="w-3 h-3" />
                                                        {new Date(item.timestamp).toLocaleString()}
                                                    </span>
                                                    <button 
                                                        onClick={(e) => deleteHistoryItem(e, item.id)}
                                                        className="text-gray-300 hover:text-red-500 p-1 -mr-1 -mt-1 opacity-0 group-hover:opacity-100 transition-opacity"
                                                        title="Âà™Èô§Ê≠§Á¥ÄÈåÑ"
                                                    >
                                                        <Trash2 className="w-3.5 h-3.5" />
                                                    </button>
                                                </div>
                                                <h4 className="font-medium text-gray-800 line-clamp-2 mb-1 group-hover:text-brand-700">
                                                    {item.params.input || "(ÁÑ°Ê®ôÈ°åËº∏ÂÖ•)"}
                                                </h4>
                                                <div className="flex flex-wrap gap-1">
                                                    {item.params.productType && <span className="text-[10px] px-1.5 py-0.5 bg-blue-50 text-blue-600 rounded">{item.params.productType}</span>}
                                                    {item.params.hasImage && <span className="text-[10px] px-1.5 py-0.5 bg-purple-50 text-purple-600 rounded flex items-center gap-0.5"><ImageIcon className="w-3 h-3"/> ÈôÑÂúñ</span>}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>

                                {history.length > 0 && (
                                    <div className="p-4 border-t border-gray-100 bg-gray-50/30">
                                        <button 
                                            onClick={clearHistory}
                                            className="w-full py-2 flex items-center justify-center gap-2 text-red-500 hover:bg-red-50 rounded-lg text-sm transition-colors"
                                        >
                                            <Trash2 className="w-4 h-4" /> Ê∏ÖÁ©∫ÊâÄÊúâÁ¥ÄÈåÑ
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {/* VIEW: HOME (Input Form) */}
                    {view === 'home' && (
                        <div className="w-full max-w-3xl mx-auto p-6 md:p-12 min-h-[90vh] flex flex-col justify-center items-center animate-in fade-in zoom-in-95 duration-300">
                            
                            <div className="w-full flex flex-col justify-center space-y-8">
                                
                                {/* Branding Header */}
                                <div className="flex flex-col gap-2 items-center text-center">
                                    <div className="flex items-center gap-3">
                                        <div className="w-12 h-12 bg-brand-600 rounded-xl flex items-center justify-center shadow-lg shadow-brand-200">
                                            <LayoutTemplate className="w-7 h-7 text-white" />
                                        </div>
                                        <h1 className="text-3xl font-bold text-neutral-900 tracking-tight">UX Flow Master</h1>
                                    </div>
                                    <p className="text-neutral-500 text-base leading-relaxed max-w-lg">
                                        Â∞àÁÇ∫Ë®≠Ë®àÂ∏´ÊâìÈÄ†ÁöÑÊô∫ËÉΩÊ™¢Êü•Âô®„ÄÇ<br/>Ëº∏ÂÖ•ÈúÄÊ±ÇÊàñË≤º‰∏äÊà™ÂúñÔºåÁû¨ÈñìË£úÂÖ®ÈÅ∫ÊºèÁöÑ UX ÁãÄÊÖã„ÄÇ
                                    </p>
                                </div>

                                {/* Main Input Card */}
                                <div className="bg-white border border-gray-100 shadow-xl shadow-brand-50/50 rounded-3xl p-8 space-y-6 w-full">
                                    
                                    {/* Main Input Area */}
                                    <div className="space-y-3">
                                        <label className="block text-sm font-bold text-neutral-800 ml-1">
                                            ‰Ω†ÊÉ≥Áπ™Ë£Ω‰ªÄÈ∫ºÂäüËÉΩÊµÅÁ®ãÔºü
                                        </label>
                                        <div 
                                            className={`relative group rounded-xl transition-all duration-300 ${
                                                isDragging 
                                                ? 'bg-brand-50 border-2 border-brand-500' 
                                                : 'bg-white border border-gray-200 shadow-sm hover:border-brand-300 focus-within:border-brand-600 focus-within:ring-4 focus-within:ring-brand-100'
                                            }`}
                                            onDragOver={handleDragOver}
                                            onDragLeave={handleDragLeave}
                                            onDrop={handleDrop}
                                            onPaste={handlePaste}
                                        >
                                            <textarea
                                                value={input}
                                                onChange={(e) => setInput(e.target.value)}
                                                placeholder="‰æãÔºöÁ∂ÅÂÆöÊâãÊ©üËôüÁ¢ºÊµÅÁ®ã... (ÊîØÊè¥ Ctrl+V Ë≤º‰∏äÊà™Âúñ)"
                                                className="w-full p-4 pb-14 rounded-xl border-none bg-transparent focus:ring-0 resize-none min-h-[160px] text-base placeholder-neutral-400"
                                                onKeyDown={(e) => {
                                                    // Change to Cmd/Ctrl + Enter for submit, allowing Enter for new lines
                                                    if (e.key === 'Enter' && (e.metaKey || e.ctrlKey)) {
                                                        e.preventDefault();
                                                        generateFlows();
                                                    }
                                                }}
                                            />
                                            
                                            {/* Image Preview & Actions */}
                                            <div className="absolute bottom-3 left-3 right-3 flex items-center justify-between pointer-events-none">
                                                <div className="pointer-events-auto">
                                                    {image ? (
                                                        <div className="relative group/image">
                                                            <img src={image} alt="Preview" className="h-12 w-auto rounded border border-gray-200 shadow-sm" />
                                                            <button onClick={removeImage} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5 shadow hover:bg-red-600"><X className="w-3 h-3"/></button>
                                                        </div>
                                                    ) : (
                                                        <button 
                                                            onClick={() => fileInputRef.current?.click()}
                                                            className="p-2 text-neutral-400 hover:text-brand-600 hover:bg-brand-50 rounded-lg transition-colors"
                                                            title="‰∏äÂÇ≥ÂúñÁâá"
                                                        >
                                                            <ImageIcon className="w-5 h-5" />
                                                        </button>
                                                    )}
                                                    <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                                </div>
                                            </div>
                                        </div>

                                        {/* Suggestion Chips */}
                                        <div className="flex flex-wrap gap-2 items-center">
                                            {['Á∂ÅÂÆöÊâãÊ©üËôüÁ¢º', 'ÈáçË®≠ÂØÜÁ¢ºÊµÅÁ®ã', 'Ë≥ºÁâ©ËªäÁµêÂ∏≥', 'ÂÄã‰∫∫Ë≥áÊñôÁ∑®ËºØ'].map(chip => (
                                                <button 
                                                    key={chip}
                                                    onClick={() => setInput(chip)}
                                                    className="px-3 py-1 text-sm bg-gray-50 border border-gray-100 rounded-full text-neutral-600 hover:border-brand-200 hover:bg-brand-50 hover:text-brand-700 transition-all"
                                                >
                                                    {chip}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* Quick Goal Input */}
                                    <div className="space-y-1.5">
                                        <label className="block text-sm font-bold text-brand-700 ml-1 flex items-center gap-1.5 uppercase tracking-wider">
                                            <Target className="w-4 h-4" />
                                            Ê†∏ÂøÉË®≠Ë®àÁõÆÁöÑ (Design Goal)
                                        </label>
                                        <input 
                                            type="text" 
                                            value={designGoal}
                                            onChange={(e) => setDesignGoal(e.target.value)}
                                            placeholder="‰æãÔºöÊ∏õÂ∞ëÂÆ¢ÊúçÊäïË®¥„ÄÅÊèêÂçáË®ªÂÜäËΩâÊèõÁéá..."
                                            className="w-full px-4 py-3 text-sm rounded-xl border border-transparent bg-brand-50/50 hover:bg-brand-50 focus:bg-white focus:border-brand-300 focus:ring-4 focus:ring-brand-100 transition-all placeholder-brand-300/70 text-brand-900"
                                        />
                                    </div>

                                    {/* Collapsible Advanced Settings */}
                                    <div className="pt-1">
                                        <button 
                                            onClick={() => setShowAdvanced(!showAdvanced)}
                                            className="flex items-center justify-start gap-1 w-full text-sm text-gray-400 hover:text-brand-600 transition-colors py-2 opacity-70 hover:opacity-100 ml-1"
                                        >
                                            <span>{showAdvanced ? 'Êî∂Ëµ∑ÈÄ≤ÈöéÂèÉÊï∏' : 'ÈÄ≤ÈöéÂèÉÊï∏Ë®≠ÂÆö (ÈÅ∏Â°´)'}</span>
                                            {showAdvanced ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
                                        </button>
                                        
                                        {showAdvanced && (
                                            <div className="mt-2 grid grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2">
                                                {[
                                                    { label: 'Áî¢ÂìÅÈ°ûÂûã', icon: Briefcase, val: productType, set: setProductType, ph: 'B2B SaaS, ÈõªÂïÜ...' },
                                                    { label: 'ÁõÆÊ®ôÊóèÁæ§', icon: Users, val: audience, set: setAudience, ph: 'ËÄÅÂπ¥‰∫∫, Â∞àÊ•≠‰∫∫Â£´...' },
                                                    { label: 'Êìç‰ΩúÂπ≥Âè∞', icon: Smartphone, val: platform, set: setPlatform, ph: 'Mobile, Web...' },
                                                    { label: 'ÁâπÊÆäÈôêÂà∂', icon: ShieldAlert, val: constraints, set: setConstraints, ph: 'Âº±Á∂≤, È´òË≥áÂÆâ...' },
                                                ].map((field, idx) => (
                                                    <div key={idx}>
                                                        <label className="block text-sm font-medium text-neutral-500 mb-1 flex items-center gap-1 ml-1">
                                                            <field.icon className="w-4 h-4" /> {field.label}
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={field.val}
                                                            onChange={(e) => field.set(e.target.value)}
                                                            placeholder={field.ph}
                                                            className="w-full px-3 py-2 text-sm rounded-lg border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-100 outline-none transition-all"
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        )}
                                    </div>

                                    {/* Primary Action Button */}
                                    <div className="pt-2">
                                        <button
                                            onClick={generateFlows}
                                            disabled={loading || (!input.trim() && !image)}
                                            className={`
                                                w-full py-4 rounded-xl flex items-center justify-center gap-3 font-bold text-lg transition-all duration-300
                                                ${loading || (!input.trim() && !image)
                                                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                                    : 'bg-brand-600 text-white shadow-xl shadow-brand-200 hover:bg-brand-700 hover:shadow-2xl hover:-translate-y-1 active:translate-y-0'
                                                }
                                            `}
                                        >
                                            <div className="w-6 h-6 flex items-center justify-center flex-shrink-0">
                                                {loading ? (
                                                    <Loader2 className="w-full h-full animate-spin" />
                                                ) : (
                                                    <Sparkles className="w-full h-full overflow-visible" />
                                                )}
                                            </div>
                                            <div>{loading ? 'Ê≠£Âú®ÂàÜÊûê UX ÊµÅÁ®ã...' : 'ÈñãÂßãÂàÜÊûê'}</div>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* VIEW: RESULT (Design Report) */}
                    {view === 'result' && result && (
                        <div className="w-full min-h-screen bg-neutral-50 animate-in slide-in-from-right-8 duration-300">
                            
                            {/* Sticky Navbar */}
                            <div className="sticky top-0 z-20 bg-white/80 backdrop-blur-md border-b border-gray-200 px-6 py-4">
                                <div className="max-w-6xl mx-auto flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={handleBackToHome}
                                            className="flex items-center gap-1 text-neutral-600 hover:text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-all font-medium"
                                        >
                                            <ArrowLeft className="w-4 h-4" />
                                            <span>ËøîÂõûÊü•Ë©¢</span>
                                        </button>
                                        <div className="h-5 w-px bg-gray-300"></div>
                                        <h2 className="text-lg font-bold text-neutral-900 flex items-center gap-2">
                                            <div className="w-6 h-6 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                                                <CheckCircle className="w-3.5 h-3.5" />
                                            </div>
                                            Ë®≠Ë®àÂàÜÊûêÂ†±Âëä
                                        </h2>
                                    </div>

                                    <button
                                        onClick={copyToClipboard}
                                        className="flex items-center gap-2 text-sm font-medium px-4 py-2 bg-white border border-gray-200 rounded-lg hover:border-brand-300 hover:text-brand-600 hover:shadow-sm transition-all"
                                    >
                                        {copied ? <Check className="w-4 h-4" /> : <Clipboard className="w-4 h-4" />}
                                        {copied ? 'Â∑≤Ë§áË£Ω' : 'Ë§áË£ΩÂ†±Âëä'}
                                    </button>
                                </div>
                            </div>

                            <div className="max-w-6xl mx-auto px-6 py-8">
                                {/* Tabs */}
                                <div className="bg-gray-100/50 p-1 rounded-xl inline-flex mb-8 border border-gray-200">
                                    {[
                                        { id: 'details', label: 'ÊµÅÁ®ãÁ¥∞ÁØÄ' },
                                        { id: 'userflow', label: 'User Flow' },
                                        { id: 'references', label: 'Á´∂ÂìÅÂèÉËÄÉ' }
                                    ].map(tab => (
                                        <button
                                            key={tab.id}
                                            onClick={() => setActiveTab(tab.id)}
                                            className={`flex items-center justify-center px-6 py-2.5 text-sm font-medium rounded-lg transition-all ${
                                                activeTab === tab.id 
                                                ? 'bg-white text-brand-700 shadow-sm ring-1 ring-black/5' 
                                                : 'text-neutral-500 hover:text-neutral-900 hover:bg-gray-200/50'
                                            }`}
                                        >
                                            {tab.label}
                                        </button>
                                    ))}
                                </div>

                                {/* Content Area */}
                                <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 min-h-[500px]">
                                    
                                    {activeTab === 'details' && (
                                        <div className="space-y-6">
                                            {/* Sub Tabs Navigation (Progress) */}
                                            <div className="flex flex-wrap gap-2 pb-4 border-b border-gray-200">
                                                {detailTabs.map((tab) => {
                                                    const isActive = activeDetailTab === tab.id;
                                                    return (
                                                        <button
                                                            key={tab.id}
                                                            onClick={() => setActiveDetailTab(tab.id)}
                                                            className={`
                                                                relative flex items-center gap-2 px-4 py-2 rounded-full text-sm font-medium transition-all
                                                                ${isActive 
                                                                    ? `${tab.bgActive} ${tab.textActive} ring-1 ring-inset ${tab.textActive.replace('text', 'ring')} shadow-sm`
                                                                    : `bg-white text-gray-400 hover:bg-gray-50 hover:text-gray-600 border border-transparent`
                                                                }
                                                            `}
                                                        >
                                                            <tab.icon className={`w-4 h-4 ${isActive ? 'currentColor' : tab.iconColor}`} />
                                                            {tab.label}
                                                        </button>
                                                    )
                                                })}
                                            </div>

                                            {/* Content Area for Sub-tabs */}
                                            <div className="min-h-[400px] flex flex-col">
                                                {detailTabs.map(tab => {
                                                    if (activeDetailTab !== tab.id) return null;
                                                    return (
                                                        <div key={tab.id} className="animate-in fade-in slide-in-from-right-8 duration-300 flex-1">
                                                            <CategoryCard
                                                                title={tab.fullLabel}
                                                                icon={<tab.icon className={`w-6 h-6 ${tab.iconColor}`} />}
                                                                items={result[tab.id]}
                                                                checkedItems={checkedItems}
                                                                toggleCheck={toggleCheck}
                                                            />
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'userflow' && result.user_flow_mermaid && (
                                        <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                            <div className="flex justify-between items-center p-4 border-b border-gray-100 bg-gray-50/50">
                                                <div className="flex items-center gap-2 pl-2">
                                                    <h3 className="text-sm font-bold text-neutral-600">Mermaid Code</h3>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <a 
                                                        href={getMermaidLiveUrl(result.user_flow_mermaid)}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="flex items-center gap-1.5 text-sm text-neutral-600 hover:text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-colors border border-transparent hover:border-brand-200"
                                                    >
                                                        <ExternalLink className="w-3.5 h-3.5" />
                                                        ÂâçÂæÄ Mermaid Live
                                                    </a>
                                                    <div className="h-4 w-px bg-gray-300 mx-1"></div>
                                                    <button
                                                        onClick={copyMermaid}
                                                        className="flex items-center gap-1.5 text-sm text-brand-600 hover:bg-brand-50 px-3 py-1.5 rounded-lg transition-colors"
                                                    >
                                                        {mermaidCopied ? <Check className="w-3.5 h-3.5" /> : <Clipboard className="w-3.5 h-3.5" />}
                                                        {mermaidCopied ? 'Â∑≤Ë§áË£Ω' : 'Ë§áË£Ω‰ª£Á¢º'}
                                                    </button>
                                                </div>
                                            </div>
                                            <div className="bg-gray-50 p-0 overflow-hidden">
                                                <pre className="font-mono text-sm text-gray-600 w-full overflow-auto p-6 bg-gray-50/50 min-h-[300px]">
                                                    {result.user_flow_mermaid}
                                                </pre>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'references' && (
                                        <div className="grid grid-cols-1 gap-6">
                                            <CategoryCard 
                                                title="Á´∂ÂìÅÂèÉËÄÉ (Competitor References)" 
                                                icon={<Globe className="w-6 h-6 text-indigo-500" />}
                                                items={result.competitor_references} 
                                                checkedItems={checkedItems}
                                                toggleCheck={toggleCheck}
                                            />
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Error Toast */}
                    {error && (
                        <div className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-red-50 text-red-600 px-6 py-3 rounded-full shadow-lg border border-red-100 flex items-center gap-3 animate-in slide-in-from-bottom-4">
                            <AlertTriangle className="w-5 h-5" />
                            {error}
                        </div>
                    )}
                </div>
            );
        }

        function CategoryCard({ title, icon, items, checkedItems, toggleCheck }) {
            if (!items || items.length === 0) return null;

            return (
                <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden h-full">
                    {/* Header: Cleaner layout without heavy borders */}
                    <div className="px-8 pt-8 pb-4 flex items-center gap-4">
                        <div className="p-2.5 bg-gray-50 rounded-xl">
                            {icon}
                        </div>
                        <div>
                            <h3 className="text-xl font-bold text-neutral-900">{title}</h3>
                        </div>
                        <span className="ml-auto text-xs font-medium text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                            {items.length} È†ÖÁõÆ
                        </span>
                    </div>

                    {/* Content List: More spacing, no background blocks */}
                    <div className="px-8 pb-8 pt-2 space-y-6">
                        {items.map((item, idx) => {
                            const isChecked = checkedItems[item.id] || false;
                            return (
                                <div 
                                    key={item.id || idx}
                                    onClick={() => toggleCheck(item.id)}
                                    className="group flex items-start gap-4 cursor-pointer"
                                >
                                    {/* Custom Checkbox */}
                                    <div className={`
                                        mt-1 w-5 h-5 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all duration-200
                                        ${isChecked 
                                            ? 'bg-neutral-800 border-neutral-800' 
                                            : 'border-gray-300 bg-white group-hover:border-brand-500'
                                        }
                                    `}>
                                        {isChecked && <Check className="w-3.5 h-3.5 text-white" />}
                                    </div>
                                    
                                    {/* Text Content */}
                                    <div className={`flex-1 transition-all duration-300 ${isChecked ? 'opacity-40' : 'opacity-100'}`}>
                                        <h4 className={`text-base font-bold mb-1.5 transition-colors ${isChecked ? 'text-neutral-500 line-through decoration-gray-300' : 'text-neutral-800 group-hover:text-brand-700'}`}>
                                            {item.title}
                                        </h4>
                                        <p className="text-sm text-neutral-500 leading-relaxed">
                                            {item.desc}
                                        </p>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UXFlowMaster />);
    </script>
</body>
</html>
